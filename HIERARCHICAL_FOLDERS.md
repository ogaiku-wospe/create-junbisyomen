# 階層的フォルダ構造ガイド

## 概要

Phase1_Evidence Analysis Systemは、証拠種別（甲号証/乙号証）を最初から分離管理する**階層的フォルダ構造**を採用しています。

このガイドでは、新しいフォルダ構造の仕組みと、既存データの移行方法について説明します。

---

## フォルダ構造の比較

### 旧形式（フラット構造）

```
事件フォルダ/
├── 甲号証/              ← 確定済み証拠のみ（ko001, ko002, ...）
├── 乙号証/              ← 確定済み証拠のみ（otsu001, otsu002, ...）
├── 未分類/              ← 甲・乙が混在（未整理の証拠）
└── 整理済み_未確定/      ← 甲・乙が混在（tmp_001, tmp_002, ...）
```

**問題点:**
- 未分類・整理済み_未確定フォルダに甲号証と乙号証が混在
- 仮番号（tmp_001）では証拠種別が判別できない
- 証拠整理時に種別を手動で判断する必要がある

---

### 新形式（階層的構造）

```
事件フォルダ/
├── 甲号証/
│   ├── 確定済み/            ← ko001, ko002, ko003, ...
│   ├── 整理済み_未確定/     ← tmp_ko_001, tmp_ko_002, ...
│   └── 未分類/              ← 未整理の甲号証
└── 乙号証/
    ├── 確定済み/            ← otsu001, otsu002, otsu003, ...
    ├── 整理済み_未確定/     ← tmp_otsu_001, tmp_otsu_002, ...
    └── 未分類/              ← 未整理の乙号証
```

**改善点:**
- 証拠種別が最初から分離されている
- 仮番号に証拠種別が明示（tmp_ko_001、tmp_otsu_001）
- 証拠整理の効率が向上
- 証拠種別ごとに独立して管理可能

---

## 証拠番号の命名規則

### 旧形式

| ステータス | 甲号証 | 乙号証 |
|----------|--------|--------|
| 未分類 | （ファイル名のまま） | （ファイル名のまま） |
| 整理済み_未確定 | tmp_001, tmp_002 | tmp_001, tmp_002 |
| 確定済み | ko001, ko002 | otsu001, otsu002 |

**問題:** tmp_001が甲号証か乙号証か区別できない

### 新形式

| ステータス | 甲号証 | 乙号証 |
|----------|--------|--------|
| 未分類 | （ファイル名のまま） | （ファイル名のまま） |
| 整理済み_未確定 | tmp_ko_001, tmp_ko_002 | tmp_otsu_001, tmp_otsu_002 |
| 確定済み | ko001, ko002 | otsu001, otsu002 |

**改善:** 仮番号の段階から証拠種別が明確

---

## 使用方法

### 1. 新規事件の作成

新規事件を作成すると、自動的に階層的フォルダ構造が作成されます。

```bash
python3 run_phase1_multi.py
```

選択肢から「新規事件を作成」を選択すると、以下のフォルダが自動生成されます：

```
事件フォルダ/
├── 甲号証/
│   ├── 確定済み/
│   ├── 整理済み_未確定/
│   └── 未分類/
└── 乙号証/
    ├── 確定済み/
    ├── 整理済み_未確定/
    └── 未分類/
```

### 2. 証拠のアップロード

#### 甲号証（原告側証拠）の場合

Google Driveの以下のフォルダにファイルをアップロード：
```
事件フォルダ/甲号証/未分類/
```

#### 乙号証（被告側証拠）の場合

Google Driveの以下のフォルダにファイルをアップロード：
```
事件フォルダ/乙号証/未分類/
```

### 3. 証拠の整理

メニューから証拠種別を選択して整理します：

```
1. 証拠を分析・整理する [甲号証]
2. 証拠を分析・整理する [乙号証]
```

整理が完了すると、自動的に該当する「整理済み_未確定」フォルダに移動され、仮番号が付与されます：

- 甲号証: `tmp_ko_001_元のファイル名.pdf`
- 乙号証: `tmp_otsu_001_元のファイル名.pdf`

### 4. 証拠番号の確定

整理済み証拠を確認後、証拠番号を確定すると「確定済み」フォルダに移動します：

```
甲号証/整理済み_未確定/tmp_ko_001_契約書.pdf
  ↓ 確定
甲号証/確定済み/ko001_契約書.pdf
```

---

## 既存データの移行

既存の旧形式フォルダから新形式への移行は、専用の移行ツールを使用します。

### 移行ツールの使用方法

#### 1. ドライラン（変更内容の確認）

まず、実際に変更を行わずに移行内容を確認します：

```bash
cd /home/user/webapp
python3 migrate_to_hierarchical_folders.py
```

出力例：
```
====================================
 階層的フォルダ構造への移行ツール
====================================

モード: ドライラン（変更は行いません）

事件を検出中...
✅ 事件を検出: 損害賠償請求事件

📋 移行プラン:

【旧フォルダ構造】
  ✓ 未分類
  ✓ 整理済み_未確定
  ✓ 甲号証（確定済み）
  ✓ 乙号証（確定済み）

【新フォルダ構造】
  作成: 甲号証/確定済み/
  作成: 甲号証/整理済み_未確定/
  作成: 甲号証/未分類/
  作成: 乙号証/確定済み/
  作成: 乙号証/整理済み_未確定/
  作成: 乙号証/未分類/

【ファイル移行計画】
  移動: ko001_契約書.pdf
    From: 甲号証/
    To:   甲号証/確定済み/
    
  移動: tmp_001_診断書.pdf
    From: 整理済み_未確定/
    To:   甲号証/整理済み_未確定/
    名前変更: tmp_ko_001_診断書.pdf
    証拠種別: 甲号証（ファイル名から自動判定）

実際に移行を実行するには、以下のコマンドを実行してください:
  python3 migrate_to_hierarchical_folders.py --execute
```

#### 2. 実行（実際の移行）

内容を確認して問題がなければ、実際に移行を実行します：

```bash
python3 migrate_to_hierarchical_folders.py --execute
```

実行すると：
1. 新しい階層的フォルダ構造を作成
2. ファイルを適切なフォルダに移動
3. 仮番号ファイルを証拠種別付きにリネーム（tmp_001 → tmp_ko_001）
4. database.jsonを更新

### 移行時の証拠種別判定

移行ツールは、ファイル名から証拠種別を自動判定します：

| ファイル名パターン | 判定結果 |
|------------------|----------|
| otsu001_*.pdf | 乙号証 |
| otsu002_*.pdf | 乙号証 |
| tmp_otsu_*.pdf | 乙号証 |
| ko001_*.pdf | 甲号証 |
| ko002_*.pdf | 甲号証 |
| tmp_ko_*.pdf | 甲号証 |
| tmp_001_*.pdf | 甲号証（デフォルト） |
| その他のファイル | 甲号証（デフォルト） |

**注意:** デフォルトは甲号証となるため、乙号証の未確定ファイルは事前にファイル名に「otsu」や「乙」を含めておくことを推奨します。

---

## 設定変更

### 階層的構造を無効化する場合

旧形式のフラット構造を使用したい場合は、`global_config.py`を編集します：

```python
# global_config.py

# 階層的なフォルダ構成を有効化
USE_HIERARCHICAL_FOLDERS = False  # True → False に変更
```

**注意:** すでに階層的構造で管理している事件は、そのまま使用できます。

---

## よくある質問（FAQ）

### Q1: 既存の事件は自動的に新形式に移行されますか？

**A:** いいえ。既存の事件は旧形式のまま動作し続けます。移行は任意であり、`migrate_to_hierarchical_folders.py`を使用して手動で実行します。

### Q2: 移行後に旧形式に戻せますか？

**A:** 技術的には可能ですが、推奨されません。移行前にバックアップを取ることを強く推奨します。

### Q3: 一部の事件だけ階層的構造にできますか？

**A:** はい。各事件は独立してフォルダ構造を持つため、一部の事件だけを階層的構造に移行できます。システムは両方の構造を自動判別して動作します。

### Q4: 移行中にエラーが発生した場合は？

**A:** 移行ツールはドライラン機能があります。必ず最初にドライランで確認してから実行してください。エラーが発生した場合は、Google Driveのゴミ箱からファイルを復元できます。

### Q5: 証拠種別の自動判定が間違っている場合は？

**A:** 移行前にファイル名に証拠種別を含めておくことを推奨します。例：
- 甲号証の場合: `tmp_ko_001_契約書.pdf`
- 乙号証の場合: `tmp_otsu_001_請求書.pdf`

---

## トラブルシューティング

### 問題: 「階層的構造が検出されない」

**原因:** サブフォルダが作成されていない

**解決策:**
```bash
# 手動でサブフォルダを作成するか、移行ツールを実行
python3 migrate_to_hierarchical_folders.py --execute
```

### 問題: 「仮番号が重複する」

**原因:** 移行時に同じ仮番号が存在する

**解決策:**
- 移行ツールは既存の最大番号+1から採番します
- 手動で重複を解消する場合は、database.jsonも更新してください

### 問題: 「証拠種別が間違って判定される」

**原因:** ファイル名に証拠種別の情報がない

**解決策:**
- 移行前にファイル名を編集（例: `tmp_001.pdf` → `tmp_otsu_001.pdf`）
- または移行後に手動で正しいフォルダに移動

---

## サポート

問題が解決しない場合は、以下の情報を含めて報告してください：

1. エラーメッセージの全文
2. 実行したコマンド
3. 事件フォルダの現在の構造（`ls -R`の出力）
4. `global_config.py`の`USE_HIERARCHICAL_FOLDERS`設定

---

## まとめ

階層的フォルダ構造により、証拠種別の管理が大幅に改善されました：

✅ **証拠種別が最初から分離**  
✅ **仮番号に証拠種別が明示**  
✅ **既存データとの互換性を維持**  
✅ **段階的な移行が可能**  

新規事件は自動的に階層的構造で作成されます。既存事件の移行は任意ですが、証拠管理の効率化のために推奨します。
