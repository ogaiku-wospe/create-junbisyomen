# システム使いやすさ改善計画

## 📊 現状分析

### ✅ 現在優れている点

1. **起動が簡単**
   - ダブルクリックで起動（start.command/start.bat）
   - セットアップスクリプト完備（setup.sh）

2. **機能が豊富**
   - 証拠整理から時系列ストーリー生成まで完結
   - マルチ事件対応
   - AI対話式改善

3. **ドキュメントが充実**
   - README、QUICKSTART、USAGE_GUIDEなど

### ⚠️ 改善の余地がある点

1. **ターミナル操作が必須**
   - 非技術者にはハードルが高い
   - メニュー選択が数字入力のみ

2. **進捗確認が分かりにくい**
   - 何件完了したか視覚的に見えない
   - エラーが起きても気づきにくい

3. **証拠分析の結果確認が面倒**
   - JSONファイルを直接見る必要がある
   - database.jsonが巨大で読みにくい

4. **準備書面作成への連携が手動**
   - database.jsonを手動でChatGPTに貼り付け
   - プロンプトも自分で作成が必要

5. **エラー発生時の対処が不明**
   - Vision API拒否された証拠の再処理方法
   - 分析失敗した証拠の一覧確認

---

## 🎯 改善提案（優先度順）

### 【最優先】Phase 1A: UI/UX改善（1-2週間）

#### 1. Webダッシュボードの追加 ⭐⭐⭐⭐⭐
**目的**: 視覚的な進捗確認と操作を可能にする

**実装内容**:
```python
# Flask/Streamlitで簡易Webダッシュボード
- 起動: python3 web_dashboard.py
- ブラウザで http://localhost:5000 を開く

【画面構成】
┌─────────────────────────────────────────────────┐
│ Phase1 証拠分析システム                            │
├─────────────────────────────────────────────────┤
│                                                 │
│ 📊 進捗状況                                       │
│   ████████████░░░░░░░░  60% (15/25件)          │
│                                                 │
│   ✅ 分析完了: 15件                               │
│   ⏳ 未処理: 8件                                  │
│   ❌ エラー: 2件                                  │
│                                                 │
│ 📁 証拠一覧                                       │
│   ┌────────────────────────────────────┐        │
│   │ 証拠番号 │ ファイル名 │ 状態 │ 日付  │        │
│   │ tmp_001  │ 契約書.pdf │ ✅   │ 8/15  │        │
│   │ tmp_002  │ 領収書.jpg │ ✅   │ 9/10  │        │
│   │ tmp_003  │ メール.pdf │ ❌   │ -     │ [再分析]│
│   └────────────────────────────────────┘        │
│                                                 │
│ 🎬 アクション                                     │
│   [証拠整理] [証拠分析] [時系列生成] [準備書面]   │
│                                                 │
└─────────────────────────────────────────────────┘
```

**メリット**:
- ✅ 視覚的に分かりやすい
- ✅ ボタンクリックで操作
- ✅ リアルタイムで進捗確認
- ✅ エラー証拠の再処理が簡単

**実装難易度**: ⭐⭐ 中（Streamlit使用で簡単）

---

#### 2. 証拠プレビュー機能 ⭐⭐⭐⭐
**目的**: 証拠内容をすぐに確認できるようにする

**実装内容**:
```python
# ダッシュボードで証拠をクリック → プレビュー表示

【プレビュー画面】
┌─────────────────────────────────────────────────┐
│ 証拠 tmp_001 - 契約書.pdf                         │
├─────────────────────────────────────────────────┤
│                                                 │
│ 📄 ファイル情報                                   │
│   作成年月日: 2021-08-15                         │
│   ファイル名: 売買契約書.pdf                      │
│   ファイルサイズ: 1.2 MB                          │
│   SHA-256: 27a9db79...                          │
│                                                 │
│ 🤖 AI分析結果                                     │
│   本証拠は2021年8月15日付の売買契約書である。      │
│   売主は株式会社山田商事、買主は田中太郎である。   │
│   第5条に「買主は売主に対し、2021年10月14日      │
│   までに代金1000万円を支払う」と記載されている。  │
│   ...                                           │
│                                                 │
│ 📅 重要な日付                                     │
│   - 2021-08-15: 契約締結日                       │
│   - 2021-10-14: 支払期限                         │
│                                                 │
│ 💰 金額情報                                       │
│   - 1,000万円: 売買代金                          │
│                                                 │
│ 👥 登場人物                                       │
│   - 株式会社山田商事: 売主                        │
│   - 田中太郎: 買主                               │
│                                                 │
│ [Google Driveで開く] [編集] [閉じる]             │
│                                                 │
└─────────────────────────────────────────────────┘
```

**メリット**:
- ✅ JSONを直接見なくて済む
- ✅ 証拠内容をすぐ確認
- ✅ 人間が読みやすい形式

**実装難易度**: ⭐⭐ 中

---

#### 3. 準備書面アシスタント ⭐⭐⭐⭐⭐
**目的**: database.jsonから準備書面を自動生成

**実装内容**:
```python
# ダッシュボードに「準備書面生成」ボタンを追加

【生成画面】
┌─────────────────────────────────────────────────┐
│ 準備書面生成アシスタント                          │
├─────────────────────────────────────────────────┤
│                                                 │
│ 📝 生成する文書を選択                             │
│   [✓] 請求の原因                                 │
│   [✓] 証拠説明書                                 │
│   [ ] 時系列表                                   │
│   [ ] 主張書面                                   │
│                                                 │
│ ⚙️ 設定                                          │
│   立場: ○ 原告側  ○ 被告側                       │
│   AIモデル: [GPT-4o ▼]                          │
│   詳細度: ●━━━━○ (5段階)                        │
│                                                 │
│ [生成開始]                                       │
│                                                 │
└─────────────────────────────────────────────────┘

【生成中】
┌─────────────────────────────────────────────────┐
│ 準備書面を生成中...                               │
├─────────────────────────────────────────────────┤
│                                                 │
│   ✅ database.jsonを読み込み中...               │
│   ⏳ 時系列整理中... (21件の証拠)                │
│   ⏳ AI生成中...                                 │
│   □ 出力ファイル作成中...                        │
│                                                 │
│   進捗: ████████░░ 80%                          │
│                                                 │
└─────────────────────────────────────────────────┘

【生成完了】
┌─────────────────────────────────────────────────┐
│ ✅ 準備書面の生成が完了しました                    │
├─────────────────────────────────────────────────┤
│                                                 │
│ 📄 生成されたファイル                             │
│   - 準備書面_請求の原因_2025-11-05.docx          │
│   - 証拠説明書_2025-11-05.xlsx                   │
│                                                 │
│ 📊 内容サマリー                                   │
│   - 引用証拠: 15件                               │
│   - 段落数: 18                                   │
│   - 文字数: 約8,500文字                          │
│                                                 │
│ [プレビュー] [ダウンロード] [Google Driveに保存] │
│                                                 │
└─────────────────────────────────────────────────┘
```

**技術実装**:
```python
# backend/brief_generator.py

import openai
from docx import Document

def generate_brief(database_json, options):
    """準備書面を自動生成"""
    
    # 1. database.jsonから情報抽出
    evidence_list = extract_evidence_timeline(database_json)
    
    # 2. AIプロンプト生成
    prompt = f"""
    あなたは{options['stance']}の訴訟代理人弁護士です。
    
    以下のdatabase.jsonを読み込み、準備書面の「請求の原因」を作成してください。
    
    【指示】
    - 時系列に沿って事実関係を記述
    - 各事実の後に証拠番号を引用（例:「（甲1号証）」）
    - 段落番号を付けて構造化
    
    【database.json】
    {json.dumps(database_json, ensure_ascii=False, indent=2)}
    """
    
    # 3. AI生成
    response = openai.ChatCompletion.create(
        model=options['model'],
        messages=[{"role": "user", "content": prompt}],
        temperature=0.3
    )
    
    content = response.choices[0].message.content
    
    # 4. Wordファイル生成
    doc = Document()
    doc.add_heading('準備書面', 0)
    doc.add_heading('第1 請求の原因', 1)
    
    for paragraph in content.split('\n\n'):
        doc.add_paragraph(paragraph)
    
    output_path = f"準備書面_{datetime.now().strftime('%Y%m%d_%H%M%S')}.docx"
    doc.save(output_path)
    
    return output_path
```

**メリット**:
- ✅ 手動でChatGPTにコピペ不要
- ✅ プロンプトを自分で書かなくて良い
- ✅ Word/Excelファイルで直接出力
- ✅ そのまま裁判所に提出可能

**実装難易度**: ⭐⭐⭐ 中～高

---

### 【高優先】Phase 1B: エラー処理改善（1週間）

#### 4. エラー証拠の自動再試行 ⭐⭐⭐⭐
**目的**: Vision API拒否などのエラーを自動で回復

**実装内容**:
```python
# エラー証拠の再処理機能

【現在の問題】
OpenAI Vision API拒否
→ "I'm sorry, I can't assist with that request."
→ 証拠が未分析のまま残る

【改善案】
1. エラー検出
   - ai_analysis.raw_response をチェック
   - "I'm sorry" または parse_error があれば再試行

2. 自動フォールバック（多段階）
   - 試行1: OpenAI GPT-4o Vision
   - 試行2: Claude Sonnet 4 Vision（フォールバック）
   - 試行3: OCRテキスト + GPT-4o（Vision不使用）
   - 試行4: 手動確認を促す

3. ダッシュボードに表示
   - エラー証拠を一覧表示
   - [再試行]ボタンでワンクリック再処理
```

**技術実装**:
```python
# evidence_error_handler.py

class EvidenceErrorHandler:
    """証拠エラーハンドラー"""
    
    def retry_failed_evidence(self, evidence_id):
        """エラー証拠を再試行"""
        
        # 1. エラー理由を判定
        error_type = self._detect_error_type(evidence_id)
        
        # 2. 適切なフォールバック選択
        if error_type == "vision_api_refused":
            # Claude Visionで再試行
            return self._retry_with_claude(evidence_id)
        
        elif error_type == "parse_error":
            # OCR + GPT-4oで再試行
            return self._retry_with_ocr(evidence_id)
        
        elif error_type == "network_error":
            # 同じ方法で再試行（リトライ）
            return self._retry_same_method(evidence_id)
        
        else:
            # 手動確認が必要
            return self._mark_for_manual_review(evidence_id)
```

**メリット**:
- ✅ エラー証拠が自動回復
- ✅ 手動介入が最小限
- ✅ 分析成功率が向上

**実装難易度**: ⭐⭐ 中

---

#### 5. バッチ処理の進捗表示 ⭐⭐⭐
**目的**: 大量証拠処理中の進捗を可視化

**実装内容**:
```python
# リアルタイム進捗表示

【現在の問題】
証拠を100件処理中...
→ 何も表示されない（30-40分）
→ 進捗が分からず不安

【改善案】
┌─────────────────────────────────────────────────┐
│ 証拠分析中                                        │
├─────────────────────────────────────────────────┤
│                                                 │
│ 全体進捗: ████████░░ 78% (78/100件)            │
│                                                 │
│ ⏳ 現在処理中: tmp_078 - メール.pdf              │
│   - ファイルダウンロード中... ✅                  │
│   - メタデータ抽出中... ✅                        │
│   - AI分析中... ⏳                               │
│   - データベース保存... □                        │
│                                                 │
│ 📊 統計                                          │
│   成功: 75件                                     │
│   エラー: 3件                                     │
│   残り: 22件                                     │
│   推定残り時間: 約8分                             │
│                                                 │
│ [一時停止] [キャンセル]                          │
│                                                 │
└─────────────────────────────────────────────────┘
```

**メリット**:
- ✅ 進捗が可視化
- ✅ 推定残り時間が分かる
- ✅ 一時停止・キャンセル可能

**実装難易度**: ⭐⭐ 中

---

### 【中優先】Phase 2: 高度な機能（2-3週間）

#### 6. AIチャットボット統合 ⭐⭐⭐⭐
**目的**: 自然言語でシステムを操作

**実装内容**:
```python
# ダッシュボードにチャット窓を追加

【チャット例】
┌─────────────────────────────────────────────────┐
│ 💬 AIアシスタント                                 │
├─────────────────────────────────────────────────┤
│                                                 │
│ あなた: 2021年8月の証拠を全部分析して             │
│                                                 │
│ AI: 2021年8月の証拠を検索しました。              │
│     該当: 5件（tmp_001～tmp_005）                │
│     分析を開始しますか？                          │
│     [はい] [いいえ]                              │
│                                                 │
│ あなた: はい                                     │
│                                                 │
│ AI: 分析を開始しました。                         │
│     進捗: 20% (1/5件) ████░░░░░░               │
│                                                 │
│ あなた: 契約書の内容を教えて                      │
│                                                 │
│ AI: 甲1号証（契約書.pdf）の内容:                 │
│     - 契約日: 2021年8月15日                      │
│     - 当事者: 山田商事（売主）、田中太郎（買主）   │
│     - 代金: 1000万円                            │
│     - 支払期限: 2021年10月14日                   │
│                                                 │
│     詳細を見ますか？                             │
│     [はい] [準備書面に使う] [証拠説明書に追加]    │
│                                                 │
└─────────────────────────────────────────────────┘
```

**メリット**:
- ✅ メニュー番号を覚えなくて良い
- ✅ 自然言語で指示できる
- ✅ 初心者でも使いやすい

**実装難易度**: ⭐⭐⭐⭐ 高

---

#### 7. 証拠比較機能 ⭐⭐⭐
**目的**: 複数証拠の矛盾や関連性を自動検出

**実装内容**:
```python
# 証拠間の関連性を自動分析

【画面】
┌─────────────────────────────────────────────────┐
│ 証拠比較分析                                      │
├─────────────────────────────────────────────────┤
│                                                 │
│ 🔍 矛盾の検出                                     │
│   ⚠️ 甲1と甲3で日付が矛盾                        │
│      甲1: 支払期限 2021-10-14                    │
│      甲3: 支払期限 2021-10-20                    │
│      → [詳細を見る]                              │
│                                                 │
│ 🔗 関連証拠の検出                                 │
│   ✅ 甲1（契約書）と甲2（納品書）は関連           │
│      共通: 山田商事、田中太郎、商品A              │
│      時系列: 甲1(8/15) → 甲2(9/10)               │
│      → [時系列ストーリーに追加]                   │
│                                                 │
│ 💰 金額の整合性チェック                           │
│   ✅ 甲1: 1000万円                               │
│   ✅ 甲2: 1000万円                               │
│   ✅ 甲3: 1000万円                               │
│   → 金額は一致しています                         │
│                                                 │
└─────────────────────────────────────────────────┘
```

**メリット**:
- ✅ 証拠の矛盾を早期発見
- ✅ 関連証拠を自動グループ化
- ✅ 準備書面の精度向上

**実装難易度**: ⭐⭐⭐⭐ 高

---

#### 8. モバイルアプリ ⭐⭐⭐
**目的**: スマホで証拠を撮影・即座にアップロード

**実装内容**:
```
【スマホアプリ】
1. 証拠を撮影
2. メモを音声入力
3. Google Driveに自動アップロード
4. システムが自動で分析開始

【ユースケース】
- 裁判所での証拠撮影
- 現場での証拠収集
- 依頼者との打ち合わせ中のメモ
```

**メリット**:
- ✅ 外出先でも証拠登録
- ✅ PCがなくても使える
- ✅ 音声入力で楽

**実装難易度**: ⭐⭐⭐⭐⭐ 非常に高

---

### 【低優先】Phase 3: 統合・最適化（1-2週間）

#### 9. 証拠テンプレート機能 ⭐⭐
**目的**: よくある証拠タイプのテンプレート

```python
# 証拠タイプ別のテンプレート

【テンプレート例】
- 契約書: 契約日、当事者、金額、条項
- 領収書: 発行日、金額、発行者、受領者
- メール: 送信日時、送信者、受信者、件名、本文
- 診断書: 診断日、医師名、病名、診断内容
```

#### 10. バックアップ・復元機能 ⭐⭐
**目的**: database.jsonの定期バックアップ

```python
# 自動バックアップ
- 毎日自動でGoogle Driveにバックアップ
- 特定時点への復元機能
- バージョン履歴の確認
```

---

## 📋 実装優先順位マトリックス

| 機能 | 効果 | 実装難易度 | 優先度 |
|------|------|----------|-------|
| **1. Webダッシュボード** | ⭐⭐⭐⭐⭐ | ⭐⭐ 中 | 🔴 最優先 |
| **2. 証拠プレビュー** | ⭐⭐⭐⭐ | ⭐⭐ 中 | 🔴 最優先 |
| **3. 準備書面アシスタント** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ 中～高 | 🔴 最優先 |
| **4. エラー自動再試行** | ⭐⭐⭐⭐ | ⭐⭐ 中 | 🟠 高 |
| **5. 進捗表示** | ⭐⭐⭐ | ⭐⭐ 中 | 🟠 高 |
| **6. AIチャット** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ 高 | 🟡 中 |
| **7. 証拠比較** | ⭐⭐⭐ | ⭐⭐⭐⭐ 高 | 🟡 中 |
| **8. モバイルアプリ** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ 非常に高 | 🟢 低 |
| **9. テンプレート** | ⭐⭐ | ⭐ 低 | 🟢 低 |
| **10. バックアップ** | ⭐⭐ | ⭐ 低 | 🟢 低 |

---

## 🚀 推奨実装ロードマップ

### フェーズ1: クイックウィン（2週間）
```
Week 1-2:
1. Webダッシュボード（基本版）
   - 進捗表示
   - 証拠一覧
   - 基本操作ボタン

2. 証拠プレビュー
   - AI分析結果の表示
   - 重要情報のハイライト
```
**期待効果**: 使いやすさが劇的に向上

---

### フェーズ2: コア機能強化（2週間）
```
Week 3-4:
3. 準備書面アシスタント
   - 「請求の原因」自動生成
   - 証拠説明書自動生成
   - Wordファイル出力

4. エラー自動再試行
   - Claude Vision フォールバック
   - OCRフォールバック
   - エラー一覧画面
```
**期待効果**: 実務で即戦力になる

---

### フェーズ3: 高度化（3-4週間）
```
Week 5-8:
5. AIチャットボット
   - 自然言語操作
   - 証拠内容質問応答

6. 証拠比較機能
   - 矛盾検出
   - 関連性分析
```
**期待効果**: プロフェッショナルツールに

---

## 💡 即座に実装できる簡易改善

### すぐできる改善（1-2日）

#### A. カラフルなターミナル出力
```python
# coloramaライブラリで色付け

from colorama import Fore, Back, Style

print(Fore.GREEN + "✅ 証拠分析完了" + Style.RESET_ALL)
print(Fore.RED + "❌ エラー発生" + Style.RESET_ALL)
print(Fore.YELLOW + "⏳ 処理中..." + Style.RESET_ALL)
```

#### B. 進捗バー追加
```python
# tqdmライブラリで進捗バー

from tqdm import tqdm

for evidence in tqdm(evidence_list, desc="証拠分析中"):
    process_evidence(evidence)

# 出力例:
# 証拠分析中: 78% |████████░░| 78/100 [03:24<01:05, 2.98s/it]
```

#### C. サマリーレポート出力
```python
# 処理完了後にMarkdownレポート生成

def generate_summary_report(database_json):
    """サマリーレポートをMarkdownで生成"""
    
    report = f"""
# 証拠分析完了レポート

## 📊 統計
- 分析完了: {completed_count}件
- エラー: {error_count}件
- 合計: {total_count}件

## ✅ 完了した証拠
{evidence_list}

## ❌ エラーが発生した証拠
{error_list}

## 📅 重要な日付
{important_dates}

## 💰 金額情報
{financial_summary}
    """
    
    with open("分析レポート.md", "w") as f:
        f.write(report)
```

**メリット**:
- ✅ 実装が超簡単（1-2日）
- ✅ すぐに使いやすくなる
- ✅ ビジュアルが改善

---

## 📝 まとめ

### 最も効果的な改善トップ3

1. **Webダッシュボード** ⭐⭐⭐⭐⭐
   - 非技術者でも使える
   - 視覚的で分かりやすい
   - 実装も比較的簡単（Streamlit使用）

2. **準備書面アシスタント** ⭐⭐⭐⭐⭐
   - 実務で即座に役立つ
   - 時間を大幅に節約
   - システムの価値が明確に

3. **エラー自動再試行** ⭐⭐⭐⭐
   - 分析成功率が向上
   - 手動介入が減る
   - システムの信頼性向上

### 推奨アクション

**今すぐ実装**:
- カラフルなターミナル出力（1日）
- 進捗バー（1日）
- サマリーレポート（1日）

**次の2週間**:
- Webダッシュボード（基本版）
- 証拠プレビュー

**次の1ヶ月**:
- 準備書面アシスタント
- エラー自動再試行

これで、使いやすさが**劇的に向上**します！🚀
