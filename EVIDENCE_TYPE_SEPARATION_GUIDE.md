# 証拠種別分離機能 - 完全ガイド

## 📋 概要

甲号証（こちらの証拠）と乙号証（相手方の証拠）を**完全に分離して管理**できる機能を実装しました。

---

## 🎯 主な変更点

### 1. 証拠種別の完全分離

すべての操作で証拠種別（甲号証/乙号証）を明示的に選択するようになりました。

```
【証拠の整理・分析】
  1. 証拠整理 → 甲号証/乙号証を選択
  2. 証拠分析 → 甲号証/乙号証を選択
  3. AI対話形式で分析内容を改善 → 甲号証/乙号証を選択

【証拠の確定・管理】
  4. 日付順に並び替えて確定 → 甲号証/乙号証を選択

【証拠の閲覧】
  5. 証拠分析一覧を表示 → 甲号証/乙号証を選択
  6. 証拠一覧をエクスポート → 甲号証/乙号証を選択
```

### 2. データベース構造の拡張

すべての証拠レコードに `evidence_type` フィールドが追加されました：

```json
{
  "evidence_id": "ko001",
  "evidence_type": "ko",    ← 新規追加
  "temp_id": "tmp_001",
  "status": "確定済み",
  ...
}
```

または

```json
{
  "evidence_id": "otsu001",
  "evidence_type": "otsu",  ← 新規追加
  "temp_id": "tmp_otsu_001",
  "status": "確定済み",
  ...
}
```

### 3. エクスポート機能の強化

CSV/Excel エクスポート時に「証拠種別」列が追加されました：

**CSV例:**
```csv
証拠種別,ステータス,証拠番号,仮番号,作成日,分析状態,...
甲号証,確定済み,ko001,tmp_001,2024-01-15,分析済み,...
甲号証,整理済み_未確定,,tmp_005,2024-02-10,未分析,...
乙号証,確定済み,otsu001,tmp_otsu_001,2024-01-20,分析済み,...
```

**Excel例:**
- 「証拠種別」列が先頭に追加
- ステータス列と分析状態列のカラーコーディング維持
- 自動列幅調整、ヘッダー固定

---

## 🚀 使い方

### Step 1: 証拠整理（未分類 → 整理済み_未確定）

```
メニューで「1」を選択

証拠種別を選択してください:
  1. 甲号証（こちらの証拠）
  2. 乙号証（相手方の証拠）
  3. キャンセル

> 1  ← 甲号証を選択

証拠整理システム [甲号証]
📁 事件: サンプル事件

... 整理処理が実行されます ...
```

### Step 2: 証拠分析

```
メニューで「2」を選択

証拠種別を選択してください:
  1. 甲号証（こちらの証拠）
  2. 乙号証（相手方の証拠）
  3. キャンセル

> 2  ← 乙号証を選択

証拠番号の入力
  単一指定: tmp_001, tmp_020
  範囲指定: tmp_001-011, tmp_020-030
  キャンセル: 空Enter

> tmp_otsu_001

... 分析処理が実行されます ...
```

### Step 3: 証拠一覧の表示

```
メニューで「5」を選択

証拠種別を選択してください:
  1. 甲号証（こちらの証拠）
  2. 乙号証（相手方の証拠）
  3. キャンセル

> 1  ← 甲号証を選択

======================================================================
  証拠分析一覧 - 甲号証
======================================================================

【確定済み - 甲号証】
----------------------------------------------------------------------
  ko001      | 2024-01-15   | ✅ 分析済み   | 契約書.pdf
             (元ID: tmp_001)
  ko002      | 2024-02-20   | ✅ 分析済み   | 請求書.pdf
             (元ID: tmp_002)

【整理済み_未確定】
----------------------------------------------------------------------
  tmp_005    | 2024-03-10   | ⚠️  未分析    | 証明書.pdf

======================================================================
  甲号証の合計: 3件
    確定済み: 2件
    整理済み_未確定: 1件
    未分類: 0件
======================================================================
```

### Step 4: エクスポート

```
メニューで「6」を選択

証拠種別を選択してください:
  1. 甲号証（こちらの証拠）
  2. 乙号証（相手方の証拠）
  3. キャンセル

> 1  ← 甲号証を選択

証拠一覧エクスポート [甲号証]

出力形式を選択してください:
  1. CSV形式
  2. Excel形式 (.xlsx)
  3. キャンセル

> 2  ← Excel形式を選択

✅ Excel形式でエクスポートしました
   ファイル: /path/to/evidence_list_サンプル事件_ko_20251021_143000.xlsx
   件数: 10件
```

**出力ファイル名の形式:**
- CSV: `evidence_list_{事件名}_ko_{タイムスタンプ}.csv`
- Excel: `evidence_list_{事件名}_otsu_{タイムスタンプ}.xlsx`

---

## 📂 フォルダ構成

```
事件フォルダ/
├── 甲号証/                  ← こちら側の証拠
│   ├── ko001_契約書.pdf
│   ├── ko002_請求書.pdf
│   └── ko003_証明書.pdf
│
├── 乙号証/                  ← 相手方の証拠
│   ├── otsu001_答弁書.pdf
│   ├── otsu002_準備書面.pdf
│   └── otsu003_反証資料.pdf
│
├── 未分類/                  ← 未整理の証拠
│   ├── document1.pdf
│   └── document2.pdf
│
├── 整理済み_未確定/         ← 仮番号が付いた証拠
│   ├── tmp_001_契約書.pdf      (甲号証予定)
│   ├── tmp_002_請求書.pdf      (甲号証予定)
│   ├── tmp_otsu_001_答弁書.pdf (乙号証予定)
│   └── tmp_otsu_002_準備書面.pdf (乙号証予定)
│
└── database.json            ← 証拠データベース
```

---

## 🔧 技術的な詳細

### global_config.py の新規定数

```python
# 証拠種別の定数
EVIDENCE_TYPE_KO = "ko"      # 甲号証（こちら側の証拠）
EVIDENCE_TYPE_OTSU = "otsu"  # 乙号証（相手側の証拠）

# 証拠種別の表示名
EVIDENCE_TYPE_DISPLAY_NAMES = {
    EVIDENCE_TYPE_KO: "甲号証",
    EVIDENCE_TYPE_OTSU: "乙号証"
}

# 証拠種別とフォルダ名のマッピング
EVIDENCE_TYPE_FOLDER_MAP = {
    EVIDENCE_TYPE_KO: EVIDENCE_FOLDER_NAME_KO,     # "甲号証"
    EVIDENCE_TYPE_OTSU: EVIDENCE_FOLDER_NAME_OTSU  # "乙号証"
}

# 証拠番号の接頭辞
EVIDENCE_PREFIX_MAP = {
    EVIDENCE_TYPE_KO: "ko",      # ko001, ko002, ...
    EVIDENCE_TYPE_OTSU: "otsu"   # otsu001, otsu002, ...
}
```

### 主要メソッドのシグネチャ変更

#### run_phase1_multi.py

```python
def select_evidence_type(self) -> Optional[str]:
    """証拠種別を選択
    
    Returns:
        'ko': 甲号証, 'otsu': 乙号証, None: キャンセル
    """

def show_evidence_list(self, evidence_type: str = 'ko'):
    """証拠分析一覧を表示
    
    Args:
        evidence_type: 'ko'（甲号証）または 'otsu'（乙号証）
    """

def export_evidence_list(self, evidence_type: str = 'ko'):
    """証拠一覧をCSV/Excel形式でエクスポート
    
    Args:
        evidence_type: 'ko'（甲号証）または 'otsu'（乙号証）
    """

def process_evidence(self, evidence_number: str, gdrive_file_info: Dict = None, evidence_type: str = 'ko') -> bool:
    """証拠の処理（完全版）
    
    Args:
        evidence_number: 証拠番号（例: tmp_001）
        gdrive_file_info: Google Driveファイル情報（オプション）
        evidence_type: 証拠種別 ('ko' または 'otsu')
    """

def edit_evidence_with_ai(self, evidence_type: str = 'ko'):
    """AI対話形式で分析内容を改善
    
    Args:
        evidence_type: 証拠種別 ('ko' または 'otsu')
    """

def analyze_and_sort_pending_evidence(self, evidence_type: str = 'ko'):
    """整理済み_未確定の証拠を日付順にソートして確定
    
    Args:
        evidence_type: 証拠種別 ('ko' または 'otsu')
    """
```

#### evidence_organizer.py

```python
def interactive_organize(self, evidence_type: str = 'ko'):
    """対話的な証拠整理
    
    Args:
        evidence_type: 証拠種別 ('ko' または 'otsu')
    """
```

---

## 🎨 エクスポートファイルの例

### CSV形式

```csv
証拠種別,ステータス,証拠番号,仮番号,作成日,分析状態,ファイル名,文書種別,作成者,宛先,要約,Google DriveファイルID
甲号証,確定済み,ko001,tmp_001,2024-01-15,分析済み,契約書.pdf,契約書,山田太郎,鈴木花子,賃貸借契約書。契約期間は2024年1月1日から...,1aB2cD3eF4gH5iJ6kL7mN8oP9qR0sT
甲号証,確定済み,ko002,tmp_002,2024-02-20,分析済み,請求書.pdf,請求書,株式会社ABC,,2024年1月分の家賃請求書。金額は10万円...,2bC3dE4fG5hI6jK7lM8nO9pQ0rS1tU
甲号証,整理済み_未確定,,tmp_005,2024-03-10,未分析,証明書.pdf,証明書,,,,,3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV
乙号証,確定済み,otsu001,tmp_otsu_001,2024-01-20,分析済み,答弁書.pdf,答弁書,佐藤一郎,,原告の主張に対する反論...,4dE5fG6hI7jK8lM9nO0pQ1rS2tU3vW
```

### Excel形式

**ヘッダー行:**
- 青背景、白文字、太字
- 固定（スクロールしても常に表示）

**データ行:**
- 証拠種別列: 「甲号証」「乙号証」を表示
- ステータス列:
  - 🟢 確定済み: 緑背景
  - 🟡 整理済み_未確定: 黄背景
  - 🔴 未分類: 赤背景
- 分析状態列:
  - 🟢 分析済み: 緑背景
  - 🟡 未分析: 黄背景

---

## ⚠️ 注意事項

### 1. 既存データベースとの互換性

既存の証拠データには `evidence_type` フィールドがない可能性があります。その場合、システムは自動的に `'ko'` (甲号証) とみなします。

**対処方法:**
- 乙号証として管理したい既存証拠については、database.json を手動で編集して `"evidence_type": "otsu"` を追加してください。

### 2. 証拠番号の命名規則

- **甲号証**: `ko001`, `ko002`, `ko003`, ...
- **乙号証**: `otsu001`, `otsu002`, `otsu003`, ...
- **仮番号（甲号証用）**: `tmp_001`, `tmp_002`, ...
- **仮番号（乙号証用）**: `tmp_otsu_001`, `tmp_otsu_002`, ...

### 3. フォルダ構成

事件フォルダ直下に以下のフォルダが必要です:
- `甲号証/` - こちら側の証拠
- `乙号証/` - 相手方の証拠
- `未分類/` - 未整理の証拠
- `整理済み_未確定/` - 仮番号が付いた証拠

---

## 🔄 ローカルリポジトリの更新

最新版を `/Users/ogaiku/create-junbisyomen` に反映するには:

```bash
cd /Users/ogaiku/create-junbisyomen
git pull origin fix/evidence-analysis-file-input
```

または更新スクリプトを使用:

```bash
./update_local_repo.sh
```

---

## 📝 変更履歴

### コミット: 799312b (2025-10-21)
- 証拠種別完全分離機能の実装
- global_config.py に証拠種別定数を追加
- すべてのメソッドに evidence_type パラメータを追加
- CSV/Excel エクスポートに証拠種別列を追加

### コミット: 96971e9 (2025-10-21)
- evidence_organizer.py に証拠種別パラメータを追加
- 証拠整理画面に証拠種別表示を追加

---

## 🎊 完了

証拠種別の完全分離機能が実装されました！

これにより、甲号証（こちらの証拠）と乙号証（相手方の証拠）を明確に区別して管理できるようになりました。

**最終更新日:** 2025年10月21日  
**ブランチ:** fix/evidence-analysis-file-input  
**コミット:** 96971e9
