# Phase 1完全版システム - Google Drive連携の完全ガイド

## 📋 目次

1. [Google Drive連携の概要](#google-drive連携の概要)
2. [入力情報（システム → Google Drive）](#入力情報システム--google-drive)
3. [出力情報（Google Drive → システム）](#出力情報google-drive--システム)
4. [認証の仕組み](#認証の仕組み)
5. [フォルダ構造](#フォルダ構造)
6. [実際の動作フロー](#実際の動作フロー)

---

## 🔗 Google Drive連携の概要

Phase 1完全版システムは、Google Driveと以下のように連携します：

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  Phase 1完全版システム（あなたのPC）                      │
│                                                         │
│  ┌──────────────────────────────────────────┐          │
│  │  1. credentials.json（認証情報）          │          │
│  │  2. token.json（アクセストークン）         │          │
│  │  3. config.py（フォルダID設定）            │          │
│  └──────────────────────────────────────────┘          │
│                    ▲                                    │
│                    │ 認証・API呼び出し                   │
│                    ▼                                    │
└─────────────────────────────────────────────────────────┘
                     │
                     │ Google Drive API
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  Google Drive（クラウドストレージ）                       │
│                                                         │
│  📁 共有ドライブ（事件管理用）                            │
│    └─ 📁 事件フォルダ（事件全体）                        │
│        ├─ 📁 甲号証フォルダ                             │
│        │   ├─ ko62.pdf ← ダウンロード                  │
│        │   ├─ ko63.jpg ← ダウンロード                  │
│        │   ├─ ko70.mp4 ← ダウンロード                  │
│        │   └─ ...                                      │
│        │                                               │
│        ├─ 📁 乙号証フォルダ（オプション）                 │
│        │                                               │
│        └─ 📄 database.json ← アップロード（自動保存）     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 📥 入力情報（システム → Google Drive）

システムが**Google Driveに保存する（アップロードする）**情報：

### 1. database.json（証拠分析結果）

**内容:**
- 事件情報（事件名、原告、被告、裁判所）
- 全証拠の完全メタデータ
- AI分析結果（完全言語化レベル4）
- 品質スコア
- 処理履歴

**保存先:**
```
Google Drive > 事件フォルダ > database.json
```

**保存タイミング:**
- 証拠を1件処理するたびに自動保存
- 手動バックアップ時

**サイズ:**
- 1証拠あたり約50-200KB
- 10証拠で約1MB
- 100証拠で約10MB

**例:**
```json
{
  "case_info": {
    "case_name": "提起前_名誉毀損等損害賠償請求事件",
    "plaintiff": "小原瞳",
    "defendant": "石村まゆか"
  },
  "evidence": [
    {
      "evidence_number": "ko62",
      "complete_metadata": {
        "file_hash": {"sha256": "abc123..."},
        "google_drive_urls": {
          "web_view_link": "https://drive.google.com/file/d/...",
          "download_link": "https://drive.google.com/uc?id=..."
        }
      },
      "phase1_complete_analysis": {
        "content_summary": "完全な内容要約...",
        "quality_scores": {
          "completeness_score": 95.0,
          "confidence_score": 90.0
        }
      },
      "status": "completed"
    }
  ]
}
```

### 2. ログファイル（オプション）

**内容:**
- 処理ログ
- エラーログ
- デバッグ情報

**保存先:**
```
Google Drive > 事件フォルダ > logs/ > phase1_YYYYMMDD.log
```

**保存タイミング:**
- 手動アップロード時のみ（自動アップロードは未実装）

---

## 📤 出力情報（Google Drive → システム）

システムが**Google Driveから取得する（ダウンロードする）**情報：

### 1. 証拠ファイル（メイン）

**取得方法:**

```python
# config.pyで指定されたフォルダID
KO_EVIDENCE_FOLDER_ID = "1NkwibbiUTzaznJGtF0kvsxFER3t62ZMx"

# このフォルダ内のファイルを検索・ダウンロード
```

**取得する情報:**

| 項目 | 説明 | 例 |
|------|------|-----|
| ファイル名 | 証拠番号を含むファイル名 | `ko62_証拠資料.pdf` |
| ファイルID | Google Drive固有のID | `1abc...xyz` |
| MIMEタイプ | ファイル形式 | `application/pdf` |
| ファイルサイズ | バイト単位 | `3456789` (約3.3MB) |
| 作成日時 | ファイル作成日時 | `2024-01-15T10:30:00Z` |
| 変更日時 | 最終変更日時 | `2024-01-15T10:35:00Z` |
| WebViewLink | ブラウザで表示するURL | `https://drive.google.com/file/d/...` |
| ダウンロードURL | 直接ダウンロードURL | `https://drive.google.com/uc?id=...` |

**ダウンロードフロー:**

```
1. Google Drive APIで証拠フォルダを検索
   ↓
2. フォルダ内のファイル一覧を取得
   ↓
3. 証拠番号に対応するファイルを特定
   ↓
4. ファイルをダウンロード（一時ディレクトリ）
   ↓
5. メタデータ抽出・AI分析
   ↓
6. 結果をdatabase.jsonに保存
   ↓
7. 一時ファイルを削除
```

### 2. database.json（既存の分析結果）

**取得タイミング:**
- システム起動時
- 進捗確認時
- 途中再開時

**用途:**
- 完了済み証拠のスキップ判定
- 進捗状況の表示
- 再処理が必要な証拠の特定

---

## 🔐 認証の仕組み

### 認証フロー

```
┌──────────────────────────────────────────────────────┐
│  ステップ1: 初回認証（1回のみ）                         │
└──────────────────────────────────────────────────────┘

あなたのPC                              Google
    │                                      │
    │  1. credentials.json を読み込み       │
    ├─────────────────────────────────────>│
    │                                      │
    │  2. ブラウザが自動的に開く             │
    │     認証画面が表示される               │
    │                                      │
    │  3. Googleアカウントでログイン         │
    │     権限の許可                        │
    ├─────────────────────────────────────>│
    │                                      │
    │  4. アクセストークンを取得             │
    │<─────────────────────────────────────┤
    │                                      │
    │  5. token.json として保存             │
    │     （次回から自動で使用）              │
    │                                      │

┌──────────────────────────────────────────────────────┐
│  ステップ2: 2回目以降（自動）                          │
└──────────────────────────────────────────────────────┘

あなたのPC                              Google
    │                                      │
    │  1. token.json を読み込み             │
    │                                      │
    │  2. アクセストークンで認証             │
    ├─────────────────────────────────────>│
    │                                      │
    │  3. API呼び出し（ファイル検索等）       │
    ├─────────────────────────────────────>│
    │                                      │
    │  4. 結果を返す                        │
    │<─────────────────────────────────────┤
    │                                      │
```

### 認証に必要なファイル

| ファイル | 説明 | 取得方法 | 場所 |
|---------|------|---------|------|
| `credentials.json` | OAuth 2.0クライアント認証情報 | Google Cloud Consoleからダウンロード | `phase1_complete_system/credentials.json` |
| `token.json` | アクセストークン | 初回認証時に自動生成 | `phase1_complete_system/token.json` |

### 権限スコープ

システムが要求するGoogle Drive権限：

```python
SCOPES = [
    'https://www.googleapis.com/auth/drive.readonly',  # 読み取り専用
    'https://www.googleapis.com/auth/drive.file'       # 作成したファイルの編集
]
```

**具体的な権限:**
- ✅ **ファイルの読み取り**: 証拠ファイルのダウンロード
- ✅ **ファイルのアップロード**: database.jsonの保存
- ✅ **ファイルの更新**: 既存のdatabase.jsonの上書き
- ❌ **ファイルの削除**: 権限なし（安全）
- ❌ **すべてのファイルへのアクセス**: 権限なし（安全）

---

## 📁 フォルダ構造

### Google Drive上の推奨構造

```
📁 共有ドライブ（または個人Drive）
  └─ 📁 事件フォルダ
      ├─ 📁 甲号証
      │   ├─ ko62_証拠1.pdf
      │   ├─ ko63_証拠2.jpg
      │   ├─ ko64_証拠3.docx
      │   ├─ ko70_動画証拠.mp4
      │   ├─ ko71_音声証拠.mp3
      │   └─ ...
      │
      ├─ 📁 乙号証（オプション）
      │   ├─ otsu1_相手方証拠.pdf
      │   └─ ...
      │
      ├─ 📁 database（オプション）
      │   ├─ database.json ← 最新版
      │   ├─ database_backup_20251019.json
      │   └─ database_backup_20251018.json
      │
      ├─ 📁 logs（オプション）
      │   ├─ phase1_20251019.log
      │   └─ ...
      │
      └─ 📄 database.json ← メインファイル
```

### config.pyでの設定

```python
# 共有ドライブのID（共有ドライブを使用する場合）
SHARED_DRIVE_ID = "0AO6q4_G7DmYSUk9PVA"

# 事件フォルダのID
CASE_FOLDER_ID = "1uux0sGt8j3EUI08nOFkBre_99jR8sN-a"

# 甲号証フォルダのID
KO_EVIDENCE_FOLDER_ID = "1NkwibbiUTzaznJGtF0kvsxFER3t62ZMx"

# 乙号証フォルダのID（オプション）
OTSU_EVIDENCE_FOLDER_ID = None
```

### フォルダIDの取得方法

```
1. Google Driveでフォルダを開く

2. ブラウザのURLバーを確認:
   https://drive.google.com/drive/folders/1uux0sGt8j3EUI08nOFkBre_99jR8sN-a
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                                          これがフォルダID

3. config.pyに設定:
   CASE_FOLDER_ID = "1uux0sGt8j3EUI08nOFkBre_99jR8sN-a"
```

---

## 🔄 実際の動作フロー

### シナリオ1: 証拠ko70の処理

```
ステップ1: 証拠ファイルの検索
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
あなたのPC                         Google Drive
    │                                  │
    │  "ko70" を含むファイルを検索       │
    ├─────────────────────────────────>│
    │  フォルダID: KO_EVIDENCE_FOLDER  │
    │                                  │
    │  検索結果:                        │
    │  - ko70_動画証拠.mp4             │
    │  - ファイルID: 1abc...xyz        │
    │  - サイズ: 58GB                  │
    │<─────────────────────────────────┤
    │                                  │

ステップ2: ファイルのダウンロード
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    │                                  │
    │  ファイルIDでダウンロード要求      │
    ├─────────────────────────────────>│
    │  ファイルID: 1abc...xyz          │
    │                                  │
    │  ファイルデータ（ストリーム）       │
    │<─────────────────────────────────┤
    │                                  │
    │  /tmp/ko70.mp4 に保存            │
    │                                  │

ステップ3: メタデータ抽出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    │                                  │
    │  【ローカル処理】                 │
    │  - ファイルハッシュ計算            │
    │  - EXIF情報抽出                  │
    │  - 動画メタデータ抽出              │
    │                                  │

ステップ4: AI分析
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    │                                  │
    │  【OpenAI APIに送信】            │
    │  GPT-4o Visionで分析             │
    │                                  │

ステップ5: 結果の保存
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    │                                  │
    │  database.jsonを更新              │
    │  ├─ メタデータ                   │
    │  ├─ AI分析結果                   │
    │  └─ 品質スコア                   │
    │                                  │
    │  database.jsonをアップロード       │
    ├─────────────────────────────────>│
    │  場所: CASE_FOLDER_ID            │
    │                                  │
    │  アップロード完了                 │
    │<─────────────────────────────────┤
    │                                  │

ステップ6: 一時ファイルの削除
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    │                                  │
    │  /tmp/ko70.mp4 を削除            │
    │  （ローカルにはファイルを残さない） │
    │                                  │
```

### シナリオ2: 途中再開

```
ステップ1: database.jsonの取得
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
あなたのPC                         Google Drive
    │                                  │
    │  database.jsonをダウンロード      │
    ├─────────────────────────────────>│
    │  場所: CASE_FOLDER_ID            │
    │                                  │
    │  database.json（最新版）         │
    │<─────────────────────────────────┤
    │                                  │

ステップ2: 進捗確認
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    │                                  │
    │  【ローカル処理】                 │
    │  database.jsonを解析              │
    │  ├─ ko62: 完了 ✅               │
    │  ├─ ko63: 完了 ✅               │
    │  ├─ ko70: 未処理 ❌             │
    │  └─ ko71: 未処理 ❌             │
    │                                  │
    │  未処理: ko70, ko71              │
    │                                  │

ステップ3: 未処理証拠の処理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    │                                  │
    │  ko70を処理（シナリオ1と同じ）     │
    │  ko71を処理                      │
    │                                  │
```

---

## 📊 データフロー図

### 全体像

```
┌────────────────────────────────────────────────────────────┐
│                                                            │
│  あなたのPC（Phase 1完全版システム）                         │
│                                                            │
│  ┌──────────────────────────────────────────────────┐    │
│  │ 入力                                              │    │
│  │ ・credentials.json（認証情報）                     │    │
│  │ ・token.json（アクセストークン）                    │    │
│  │ ・config.py（フォルダID）                          │    │
│  │ ・OPENAI_API_KEY（環境変数）                      │    │
│  └──────────────────────────────────────────────────┘    │
│                          │                                │
│                          ▼                                │
│  ┌──────────────────────────────────────────────────┐    │
│  │ 処理                                              │    │
│  │ 1. Google Driveから証拠ファイルをダウンロード        │    │
│  │ 2. メタデータ抽出（ハッシュ、EXIF等）               │    │
│  │ 3. ファイル処理（画像抽出、テキスト抽出等）          │    │
│  │ 4. AI分析（GPT-4o Vision）                        │    │
│  │ 5. 品質評価                                       │    │
│  └──────────────────────────────────────────────────┘    │
│                          │                                │
│                          ▼                                │
│  ┌──────────────────────────────────────────────────┐    │
│  │ 出力                                              │    │
│  │ ・database.json（ローカル保存）                    │    │
│  │ ・database.json（Google Driveにアップロード）       │    │
│  │ ・ログファイル                                     │    │
│  └──────────────────────────────────────────────────┘    │
│                                                            │
└────────────────────────────────────────────────────────────┘
                          ▲
                          │
                Google Drive API
                          │
                          ▼
┌────────────────────────────────────────────────────────────┐
│                                                            │
│  Google Drive（クラウドストレージ）                          │
│                                                            │
│  📁 事件フォルダ                                            │
│    ├─ 📁 甲号証フォルダ                                    │
│    │   ├─ ko62.pdf ←─┐                                   │
│    │   ├─ ko63.jpg ←─┼─ ダウンロード                      │
│    │   └─ ko70.mp4 ←─┘                                   │
│    │                                                      │
│    └─ 📄 database.json ←─── アップロード                  │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## 🔒 セキュリティとプライバシー

### データの保存場所

| データ | ローカル（PC） | Google Drive | OpenAI |
|-------|-------------|--------------|--------|
| 証拠ファイル（原本） | ❌ 一時のみ | ✅ 永続保存 | ❌ 送信のみ |
| メタデータ | ✅ database.json | ✅ database.json | ❌ |
| AI分析結果 | ✅ database.json | ✅ database.json | ❌ |
| credentials.json | ✅ | ❌ | ❌ |
| token.json | ✅ | ❌ | ❌ |

### プライバシー保護

- ✅ **証拠ファイル**: 処理後に一時ファイルを削除
- ✅ **OpenAI**: 分析結果のみを保存、原本は送信後に破棄
- ✅ **Google Drive**: OAuth 2.0認証で安全にアクセス
- ✅ **認証情報**: ローカルのみ保存、他者と共有しない

---

## 📝 まとめ

### Google Driveとの連携内容

| 動作 | 方向 | 内容 | タイミング |
|------|------|------|----------|
| **ダウンロード** | Google Drive → PC | 証拠ファイル | 分析時 |
| **ダウンロード** | Google Drive → PC | database.json | 起動時・再開時 |
| **アップロード** | PC → Google Drive | database.json | 分析完了時 |
| **アップロード** | PC → Google Drive | ログファイル | 手動時のみ |

### 主要なフォルダID

```python
# config.pyで設定が必要
SHARED_DRIVE_ID = "0AO6q4_G7DmYSUk9PVA"  # 共有ドライブ（オプション）
CASE_FOLDER_ID = "1uux0sGt8j3EUI08nOFkBre_99jR8sN-a"  # 事件フォルダ（必須）
KO_EVIDENCE_FOLDER_ID = "1NkwibbiUTzaznJGtF0kvsxFER3t62ZMx"  # 甲号証（必須）
```

### 認証ファイル

```bash
phase1_complete_system/
├── credentials.json  # Google Cloud Consoleから取得（1回のみ）
└── token.json        # 初回認証時に自動生成
```

---

**最終更新:** 2025-10-19  
**バージョン:** 3.2  
**対応:** Google Drive API v3
