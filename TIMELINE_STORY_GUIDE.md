# 時系列ストーリー組み立て機能ガイド

## 概要

証拠データベースから証拠を抽出し、**時系列に沿って客観的なストーリー**を自動生成する機能です。

### 主な特徴

✅ **完全に客観的**: 法的判断や主観的評価を一切含まない  
✅ **AI生成オプション**: より読みやすいナラティブを自動生成  
✅ **証拠間の関連性分析**: 時間的に近接した証拠グループを自動検出  
✅ **多様な出力形式**: JSON、Markdown、HTML、テキスト形式に対応  
✅ **証拠説明書対応**: 証拠の作成年月日を正確に抽出

---

## 使用方法

### 基本的な流れ

1. **Phase1システムを起動**
   ```bash
   cd /home/user/webapp
   python3 run_phase1_multi.py
   ```

2. **事件を選択**
   - 既存の事件から選択するか、新規事件を作成

3. **メインメニューから選択**
   ```
   7. 時系列ストーリーの生成（証拠を時系列で整理）
   ```

4. **AI機能の選択**
   - **オプション1（推奨）**: AI生成の客観的ストーリー
     - Claude Sonnet 4を使用して、読みやすい日本語のストーリーを生成
     - 証拠間の関連性や時系列の流れを自然に表現
     - 事実と証拠の紐付けを明確に記録
   - **オプション2**: 基本的なストーリー
     - AIを使用せず、証拠を時系列順に単純に並べる

5. **出力形式の選択**
   - JSON形式：プログラムで処理可能
   - Markdown形式：Gitや文書エディタで読みやすい
   - HTML形式：ブラウザで見やすく表示
   - テキスト形式：シンプルなテキストファイル
   - すべての形式：上記すべてを一度に出力
   - **🆕 自動Google Driveアップロード**: 全形式が自動的にGoogle Driveの事件フォルダにアップロードされます

---

## 機能の詳細

### 1. 時系列イベント抽出

証拠から以下の日付情報を抽出します（優先順）：

1. **document_date**: 証拠説明書に記載する作成年月日
2. **EXIF情報**: 画像の撮影日時
3. **ファイル作成日時**: メタデータの作成日
4. **AI分析結果**: 証拠分析で抽出された日付
5. **タイムライン情報**: related_factsのtimeline

### 1.5. database.jsonのAI分析結果を最大限活用 **🆕**

Phase1で分析された証拠の詳細情報を時系列ストーリーに統合:

- **related_facts**: 
  - `key_facts`: 重要な事実
  - `timeline`: 時系列情報
  - `contextual_background`: 背景情報
  
- **legal_significance**:
  - `relevance_assessment`: 法的関連性評価
  - `key_legal_points`: 重要な法的ポイント
  - `evidentiary_value`: 証拠価値
  
- **temporal_information**:
  - `timeline`: 時系列的な文脈説明

これらの情報がClaude AIプロンプトに統合され、より詳細で文脈豊かなストーリーが生成されます。

### 2. 客観的ストーリー生成（Claude AI使用）

**🆕 Claude Sonnet 4 による高品質な分析**

- OpenAI GPT-4o から Anthropic Claude Sonnet 4 に変更
- より詳細で正確な事実抽出
- 高品質な日本語のナラティブ生成
- 証拠との紐付けが明確

### 3. 事実と証拠の紐付け **🆕**

各事実がどの証拠によって裏付けられているかを明確に記録：

```json
"fact_evidence_mapping": [
  {
    "fact_id": "fact_001",
    "fact_description": "2020年1月15日、A社とB社の間で業務委託契約が締結された",
    "date": "2020-01-15",
    "supporting_evidence": ["ko001"],
    "evidence_numbers": ["甲001"],
    "confidence": "high"
  }
]
```

### 4. 自然言語による改善機能 **🆕**

ユーザーが自然言語で改善指示を出せる機能：

- 「もっと詳しく説明してください」
- 「簡潔にまとめてください」
- 「時系列の流れをわかりやすく」
- 「重要な事実を強調してください」

AIが指示に従ってストーリーを改善し、改善前後を比較して選択できます。

### 5. 依頼者発言・メモの統合 **🆕**

証拠だけでなく、依頼者からのヒアリング内容や発言も時系列に統合:

#### 5-1. 日付指定あり（特定の出来事）

- **メニュー8 → 選択肢1-3**: 特定の日付に関する発言
- 発言の追加（日付、内容、状況説明）
- 登録済み発言の一覧表示
- テキストファイルから一括インポート

依頼者発言は証拠と同じタイムライン上に配置され、事実形成に活用されます。

#### 5-2. 包括的情報（日付なし、複数事実にわたる）**🆕🆕**

- **メニュー8 → 選択肢4-5**: 全体的な文脈情報
- 事件の背景、人物関係、全体的な経緯など
- 複数の事実にわたる包括的な情報を記録
- AIが時系列ストーリー生成時に全体の文脈として活用

**使用例**:
- 「A社とB社は10年来の取引関係にあり、過去に数度のトラブルがあった」
- 「契約締結当時、双方の担当者は友好的な関係にあった」
- 「本件は2019年から続く一連の紛争の一部である」

これらの包括的情報はAIが自動的に考慮し、より文脈豊かで理解しやすいストーリーを生成します。

### 6. 基本的なストーリー生成（AI不使用）

#### 基本的なストーリー（AI不使用）

```
【2020年】
──────────────────────────────────────

◆ 2020-01-15 (甲001)
  契約書の写し。A社とB社の間で締結された業務委託契約。
  契約金額は500万円、履行期間は2020年2月1日から6月30日まで。

◆ 2020-03-20 (甲002)
  請求書の写し。A社からB社への第1回請求。金額250万円。

【2021年】
──────────────────────────────────────
...
```

#### Claude AI生成の客観的ストーリー **🆕**

```
# 事件の時系列ストーリー（客観的事実の流れ）

## 概要
本件は、A社とB社の間の業務委託契約に関する一連の証拠である。
2020年1月の契約締結から2021年12月の最終通知まで、約2年間の
経緯が記録されている。

## 時系列の流れ

### 契約締結期（2020年1月-2月）
2020年1月15日、A社とB社の間で業務委託契約が締結された（証拠: 甲001）。
契約金額は500万円で、履行期間は2020年2月1日から6月30日までと定められた。

### 履行期間（2020年2月-6月）
2020年3月20日、A社はB社に対して第1回の請求書を発行した（証拠: 甲002）。
請求金額は契約金額の半額である250万円であった。

2020年5月10日、B社から入金が確認されたことを示す振込明細書が存在する
（証拠: 甲003）。振込金額は請求額と一致する250万円であった。
...

## 主要な出来事のまとめ
- 2020年1月: 業務委託契約締結
- 2020年3月: 第1回請求
- 2020年5月: 入金確認
- 2020年8月: 第2回請求
- 2021年3月: 履行遅延に関する通知
- 2021年12月: 最終通知
```

#### 事実と証拠の紐付け **🆕**

```
【事実と証拠の紐付け】

1. 2020年1月15日、A社とB社の間で業務委託契約が締結された
   日付: 2020-01-15
   裏付け証拠: 甲001
   確実性: high

2. 2020年3月20日、A社はB社に対して第1回の請求書を発行した
   日付: 2020-03-20
   裏付け証拠: 甲002
   確実性: high

3. 2020年5月10日、B社から250万円の入金が確認された
   日付: 2020-05-10
   裏付け証拠: 甲003
   確実性: high
...
```

### 3. 証拠間の関連性分析

AI機能を使用すると、以下の分析も自動実行されます：

#### 時間的な証拠グループ

1ヶ月以内に作成された証拠をグループ化：

```
【時間的に近接した証拠グループ】
  1. 2020-01-10 - 2020-01-25: 5件
     証拠: 甲001, 甲002, 甲003, 甲004, 甲005
  
  2. 2020-06-15 - 2020-07-05: 3件
     証拠: 甲010, 甲011, 甲012
```

#### 時系列上のギャップ

3ヶ月以上の空白期間を検出：

```
【時系列上のギャップ】
  - 2020-03-20 から 2020-08-10 まで約143日間のギャップ
  - 2021-02-15 から 2021-09-01 まで約198日間のギャップ
```

---

## 出力ファイル形式

### JSON形式

```json
{
  "metadata": {
    "case_id": "meiyokison_case001",
    "case_name": "名誉毀損事件",
    "generated_at": "2025-10-22T10:30:00",
    "total_events": 25,
    "ai_generated": true,
    "ai_model": "claude-sonnet-4-20250514"
  },
  "timeline": [
    {
      "date": "2020-01-15",
      "date_display": "2020-01-15",
      "date_precision": "day",
      "confidence": "確実",
      "evidence_id": "ko001",
      "evidence_number": "甲001",
      "description": "契約書の写し..."
    }
  ],
  "ai_narrative": "# 事件の時系列ストーリー...",
  "fact_evidence_mapping": [
    {
      "fact_id": "fact_001",
      "fact_description": "2020年1月15日、A社とB社の間で業務委託契約が締結された",
      "date": "2020-01-15",
      "supporting_evidence": ["ko001"],
      "evidence_numbers": ["甲001"],
      "confidence": "high"
    }
  ],
  "key_facts": [
    "2020年1月15日に業務委託契約締結",
    "2020年3月20日に第1回請求発行"
  ],
  "relationships": {
    "temporal_clusters": [...],
    "chronological_gaps": [...]
  }
}
```

### Markdown形式

- GitHub、VSCode、Obsidianなどで読みやすい
- 見出し、リスト、強調表示を活用
- AI生成ストーリーと詳細データを両方含む

### HTML形式

- ブラウザで見やすく表示
- カラフルで読みやすいデザイン
- 年ごとにセクション分け
- 証拠間の関連性を視覚的に表示

### テキスト形式

- シンプルなテキストファイル
- 印刷やメール添付に最適
- 基本的な罫線とインデントで整形

---

## 自然言語改善機能の使い方 **🆕**

### 概要

生成されたストーリーを自然言語の指示で改善できる対話型機能です。

### 使用可能な指示の例

#### 1. 詳細度の調整
```
✅ 「もっと詳しく説明してください」
✅ 「簡潔にまとめてください」
✅ 「要点のみを抽出してください」
```

#### 2. 表現の調整
```
✅ 「専門用語を避けて平易な表現にしてください」
✅ 「ビジネス文書としてフォーマルな表現にしてください」
✅ 「時系列の流れをもっとわかりやすく説明してください」
```

#### 3. 構成の調整
```
✅ 「重要な事実を強調してください」
✅ 「契約関連の事実を詳しく説明してください」
✅ 「時系列のギャップをより明確に示してください」
```

#### 4. 証拠の扱い
```
✅ 「各事実の裏付け証拠をより明確にしてください」
✅ 「複数の証拠が関連する部分を詳しくしてください」
```

### 改善プロセス

1. **初回生成**: システムがClaude AIでストーリーを生成
2. **表示**: 生成されたストーリーと事実・証拠の紐付けを確認
3. **改善指示**: 自然言語で改善したい点を入力
4. **再生成**: Claude AIが指示に従ってストーリーを改善
5. **比較**: 改善前後を比較して、どちらを採用するか選択
6. **繰り返し**: さらに改善したい場合は再度指示可能

### 実際の使用例

```
【初回生成後】
改善指示を入力してください（Enter=スキップ）: もっと詳しく説明してください

【改善結果】
✅ 改善されたストーリーが生成されました

【変更点】
- 各契約条項の詳細を追加
- 支払いの経緯をより詳細に記述
- 通知の内容を具体的に説明

採用しますか？ (y/n): y

さらに改善指示を入力してください（Enter=終了）: 時系列のギャップを強調してください

【改善結果】
✅ 時系列のギャップ部分が強調されました

【変更点】
- 3ヶ月以上の空白期間を明示
- ギャップの理由を客観的に記述（証拠がないことを明記）

採用しますか？ (y/n): y
```

### 依頼者発言管理の使用例

#### 日付指定ありの発言（特定の出来事）

```
【メインメニュー】
選択 (0-10): 8

【依頼者情報管理メニュー】

【日付指定あり（特定の出来事）】
  1. 依頼者発言を追加
  2. 登録済み発言を表示
  3. ファイルから一括インポート（テキスト形式）

【包括的情報（日付なし、複数事実にわたる）】🆕
  4. 包括的な発言・メモを追加
  5. 登録済み包括的発言を表示

  0. メインメニューに戻る

選択 (0-5): 1

【依頼者発言の追加】
発言または出来事に関する日付を入力してください（YYYY-MM-DD形式）
例: 2023-05-15
日付: 2020-03-25

発言内容またはメモを入力してください（複数行可、終了は空行）
契約締結の際、相手方から口頭で「支払いは分割でも構わない」と
言われたが、契約書には記載されなかった。
[空行]

状況説明や背景情報を入力してください（省略可、終了は空行）
契約締結の場にB社の担当者2名が同席していた。
[空行]

✅ 依頼者発言を追加しました
```

#### 包括的発言の追加（日付なし、複数事実にわたる）**🆕**

```
選択 (0-5): 4

【包括的な発言・メモの追加】
※ 日付指定なし、複数の事実にわたる全体的な情報を記録します
※ AIが時系列ストーリー生成時に全体の文脈として活用します

タイトルまたは概要を入力してください
例: 事件の全体的な経緯、当事者間の関係性、背景情報
タイトル: 両社の長期的な取引関係

カテゴリを選択してください
  1. 事件の背景
  2. 人物関係
  3. 全体的な経緯
  4. その他
選択 (1-4): 1

両社の長期的な取引関係 の詳細内容を入力してください（複数行可、終了は空行）
A社とB社は2010年から継続的な取引関係にあり、年間約5000万円規模の
業務委託契約を結んできた。過去には2015年と2018年に支払い遅延があったが、
いずれも話し合いで解決している。両社の担当者は定期的に会議を行い、
良好な関係を維持してきた。
[空行]

✅ 包括的な発言・メモを追加しました
   時系列ストーリー生成時にAIが自動的に考慮します
```

#### 包括的発言の表示

```
選択 (0-5): 5

【登録済み包括的発言一覧】（3件）
----------------------------------------------------------------------

1. ID: context_001
   タイトル: 両社の長期的な取引関係
   カテゴリ: 事件の背景
   内容: A社とB社は2010年から継続的な取引関係にあり、年間約5000万円規模の
業務委託契約を結んできた。過去には2015年と2018年に支払い遅延があったが...
   登録日時: 2025-10-22T16:45:00

2. ID: context_002
   タイトル: 担当者の交代による影響
   カテゴリ: 人物関係
   内容: 2020年4月にB社の担当者が田中氏から佐藤氏に交代した。
新担当者の佐藤氏は業務に不慣れで、連絡が滞りがちになった...
   登録日時: 2025-10-22T16:50:00

3. ID: context_003
   タイトル: 本件紛争の位置づけ
   カテゴリ: 全体的な経緯
   内容: 本件は2019年から続く一連の支払いトラブルの最終局面である。
これまでに3回の和解協議が行われたが、いずれも決裂している...
   登録日時: 2025-10-22T16:55:00
```

### 一括インポートの例

テキストファイル（例: `client_notes.txt`）:
```
[2020-01-10]
最初の打ち合わせでB社から業務委託の提案を受けた。
当初は金額500万円の提示があった。

[2020-03-25]
契約締結の際、相手方から口頭で「支払いは分割でも構わない」と
言われたが、契約書には記載されなかった。

[2020-08-15]
B社から電話で支払い遅延について謝罪があった。
「来月には必ず支払う」との約束だった。
```

インポート後、これらは時系列ストーリーに統合されます。

---

## 技術的詳細

### TimelineBuilderクラス

主要なメソッド：

1. **`build_timeline(include_client_statements=True)`**: 証拠と依頼者発言から時系列イベントを抽出
2. **`generate_narrative()`**: 基本的なナラティブを生成
3. **`generate_objective_narrative()`**: AI生成の客観的ストーリー
4. **`analyze_evidence_relationships()`**: 証拠間の関連性を分析
5. **`export_timeline()`**: 各種形式でエクスポート
6. **`add_client_statement(date, statement, context)`**: 依頼者発言を追加 🆕
7. **`extract_related_facts_from_evidence()`**: database.jsonからrelated_factsを抽出 🆕
8. **`extract_legal_significance_from_evidence()`**: legal_significance情報を抽出 🆕
9. **`extract_temporal_context_from_evidence()`**: 時系列文脈を抽出 🆕

### Claude AI生成プロンプト **🆕**

**使用モデル**: Claude Sonnet 4 (claude-sonnet-4-20250514)

```
【要件】
1. 完全に客観的・中立的な記述（法的判断や評価を含めない）
2. 証拠から得られる事実のみを記述
3. 時系列順に整理された流れ
4. 各事実の日付と証拠番号を明記
5. 事実間の因果関係は客観的に記述可能な範囲のみ
6. 読みやすい日本語の文章形式
7. 🆕 **各事実がどの証拠によって裏付けられているかを明確に示す**
```

**改善機能**:
- ユーザーが自然言語で改善指示を出せる
- 例: 「もっと詳しく」「簡潔に」「時系列を強調」
- AIが指示に従ってストーリーを再生成
- 改善前後を比較して選択可能

### 日付抽出ロジック

優先順位に基づいて日付を抽出：

```python
# 1. complete_metadata.format_specific.document_date
# 2. complete_metadata.format_specific.exif_data.DateTime*
# 3. complete_metadata.basic.created_time
# 4. ai_analysis.evidence_metadata.creation_date
# 5. ai_analysis.related_facts.timeline の最初の日付
```

---

## 使用例

### ケース1: 契約紛争事件

**証拠**: 契約書、請求書、メール、領収書など25件

**生成されたストーリー**:
- 契約締結から紛争発生までの時系列が明確に
- 支払い履歴が日付順に整理される
- 契約違反の通知と対応の流れが客観的に記述される

### ケース2: 名誉毀損事件

**証拠**: SNS投稿スクリーンショット、メール、通知書など40件

**生成されたストーリー**:
- 投稿日時順にSNS上での経緯が整理される
- 通知と削除要請の時系列が明確になる
- 証拠間の時間的ギャップが自動検出される

---

## トラブルシューティング

### 日付が抽出されない

**原因**: 証拠に日付情報が含まれていない

**解決方法**:
1. Phase1分析で `temporal_information.document_date` が正しく抽出されているか確認
2. 必要に応じて「AI対話形式で分析内容を改善」で日付を追加
3. メタデータにEXIF情報があるか確認

### AIストーリー生成が失敗する

**原因**: Anthropic APIキーが設定されていない、またはAPI呼び出しエラー

**解決方法**:
1. `.env` ファイルに `ANTHROPIC_API_KEY` が正しく設定されているか確認
2. インターネット接続を確認
3. 基本的なストーリー（AI不使用）を選択

### 証拠が多すぎてエクスポートに時間がかかる

**対策**:
- JSON形式のみをエクスポート（最も高速）
- AI生成を使用しない
- 証拠を絞り込んでから実行

---

## FAQ

### Q1: 法的評価は含まれますか？

**A**: いいえ。完全に客観的な事実のみを記述します。法的判断や主観的評価は一切含みません。

### Q2: 証拠説明書に使用できますか？

**A**: はい。生成されたストーリーは証拠説明書の「立証趣旨」欄の参考資料として活用できます。

### Q3: AIと基本的なストーリーの違いは？

**A**: AI生成は読みやすい日本語の文章形式で、証拠間の時系列的な流れを自然に表現します。基本的なストーリーは証拠を単純に時系列順に並べたリスト形式です。

### Q4: 複数事件を横断してストーリーを生成できますか？

**A**: 現在は1事件ごとの生成のみ対応しています。複数事件の場合は、事件ごとに個別に生成してください。

### Q5: 出力ファイルはどこに保存されますか？

**A**: 
- **ローカル保存**: `{LOCAL_WORK_DIR}/{case_id}/timeline/` ディレクトリに保存されます。
- **Google Drive保存** 🆕: 自動的にGoogle Driveの事件フォルダ内の `timeline` サブフォルダにアップロードされます。
  - Google Driveにアップロードされたファイルはウェブリンクが表示されます。
  - 事件フォルダ構造: `事件フォルダ/timeline/timeline_YYYYMMDD_HHMMSS.{json|md|html|txt}`
  - ファイル名には生成日時が含まれます（例: `timeline_20251022_143000.json`）

---

## まとめ

時系列ストーリー組み立て機能は、証拠データベースから**客観的な事実の流れ**を自動生成する強力なツールです。

### 推奨ワークフロー

1. ✅ Phase1で全証拠を分析（日付情報を確実に抽出）
2. ✅ 時系列ストーリー生成（AI生成を推奨）
3. ✅ HTML形式でエクスポート（視覚的に確認）
4. ✅ 証拠説明書の作成時に参照
5. ✅ 準備書面で時系列を引用

### データ構造

#### client_statements.json（日付指定あり）

特定の日付に関する依頼者発言は以下の形式で保存されます:

```json
{
  "metadata": {
    "case_id": "case_001",
    "case_name": "事件名",
    "last_updated": "2025-10-22T15:30:00"
  },
  "statements": [
    {
      "statement_id": "client_001",
      "date": "2020-03-25",
      "statement": "契約締結の際、相手方から口頭で...",
      "context": "契約締結の場にB社の担当者2名が同席していた",
      "added_at": "2025-10-22T15:30:00"
    }
  ]
}
```

保存場所: `{LOCAL_WORK_DIR}/{case_id}/client_statements.json`

#### client_general_context.json（包括的情報）**🆕**

日付なしの包括的情報は以下の形式で保存されます:

```json
{
  "metadata": {
    "case_id": "case_001",
    "case_name": "事件名",
    "last_updated": "2025-10-22T16:45:00",
    "description": "依頼者の包括的な発言・メモ（日付なし、複数事実にわたる全体的な文脈情報）"
  },
  "contexts": [
    {
      "context_id": "context_001",
      "title": "両社の長期的な取引関係",
      "content": "A社とB社は2010年から継続的な取引関係にあり...",
      "category": "事件の背景",
      "added_at": "2025-10-22T16:45:00"
    },
    {
      "context_id": "context_002",
      "title": "担当者の交代による影響",
      "content": "2020年4月にB社の担当者が...",
      "category": "人物関係",
      "added_at": "2025-10-22T16:50:00"
    }
  ]
}
```

保存場所: `{LOCAL_WORK_DIR}/{case_id}/client_general_context.json`

**カテゴリ**:
- 事件の背景: 事件全体の背景や前提となる状況
- 人物関係: 当事者間の関係性や人物に関する情報
- 全体的な経緯: 時系列全体を通した流れや位置づけ
- その他: 上記に該当しない包括的情報

### 今後の拡張予定

- [ ] 複数事件の横断検索
- [ ] テーマ別の証拠グループ化（契約、支払い、通知など）
- [ ] ビジュアルタイムライン（図表生成）
- [ ] 証拠の自動分類と関連性スコア
- [ ] 依頼者発言の編集・削除機能
- [ ] 依頼者発言へのタグ付け機能

---

**バージョン**: 1.1  
**最終更新**: 2025年10月22日  
**対応システム**: Phase1_Evidence Analysis System v3.8.0+
