# 時系列ストーリー組み立て機能 - 実装サマリー

## 実装日時
2025年10月22日

## 概要

証拠データベースから証拠を抽出し、**時系列に沿って客観的なストーリー**を自動生成する機能を実装しました。

法的判断を一切含まず、証拠から抽出された事実のみを時系列で整理することで、準備書面作成や証拠説明書の作成を効率化します。

---

## 実装した機能

### 1. TimelineBuilderクラス（timeline_builder.py）

#### 主要クラス

**TimelineEvent**
- 時系列イベントを表現するクラス
- 日付、証拠ID、証拠番号、説明、確実性を管理
- 日付の粒度判定（日、月、年）
- ソート用のキー生成

**TimelineBuilder**
- 証拠データベースから時系列タイムラインを構築
- 証拠から日付情報を自動抽出
- 客観的なナラティブ（ストーリー）を生成
- 証拠間の関連性を分析
- 多様な形式でエクスポート

#### 新機能

1. **AI生成の客観的ストーリー** (`generate_objective_narrative()`)
   - GPT-4oを使用して読みやすいストーリーを生成
   - 完全に客観的・中立的な記述
   - 時系列の流れを自然な日本語で表現

2. **証拠間の関連性分析** (`analyze_evidence_relationships()`)
   - 時間的に近接した証拠グループの検出（1ヶ月以内）
   - 時系列上のギャップの識別（3ヶ月以上）
   - テーマ別クラスタリング（今後実装予定）

3. **多様な出力形式** (`_export_json()`, `_export_markdown()`, `_export_html()`, `_export_text()`)
   - **JSON**: プログラムで処理可能、API連携に適している
   - **Markdown**: Git、VSCode、Obsidianで読みやすい
   - **HTML**: ブラウザで見やすく表示、カラフルなデザイン
   - **Text**: シンプルなテキストファイル、印刷に適している

4. **日付抽出の優先順位**
   ```
   1. document_date（証拠説明書の作成年月日）
   2. EXIF情報（画像の撮影日時）
   3. ファイル作成日時
   4. AI分析結果
   5. タイムライン情報
   ```

---

### 2. run_phase1_multi.pyの更新

#### メニュー項目7の拡張

```python
def generate_timeline_story(self):
    """時系列ストーリーの生成（拡張版）"""
```

**主な改善点**:
- AI生成と基本的なストーリーの選択肢を追加
- 出力形式の選択肢を拡張（JSON、Markdown、HTML、Text）
- 証拠間の関連性分析結果を画面に表示
- ユーザーフレンドリーなインタラクティブUI

**使用フロー**:
1. AI機能の選択（推奨：AI生成）
2. データベース読み込みと分析
3. ストーリー生成（AI使用時は数十秒）
4. 生成結果の画面表示
5. エクスポート形式の選択
6. ファイル出力
7. 証拠間の関連性分析結果表示

---

### 3. ドキュメント

#### TIMELINE_STORY_GUIDE.md

**内容**:
- 機能の概要と特徴
- 詳細な使用方法
- 出力形式の説明
- 技術的詳細
- 使用例とケーススタディ
- トラブルシューティング
- FAQ

#### test_timeline_builder.py

**テスト項目**:
- TimelineEventクラスの動作確認
- 日付パース機能のテスト
- TimelineBuilderの基本機能テスト
- エクスポート機能の確認

---

## 技術的詳細

### 依存関係

**新規追加**:
- `openai`: GPT-4oによるストーリー生成
- `python-dotenv`: 環境変数管理（既存）

**既存モジュール**:
- `case_manager`: 事件管理
- `gdrive_database_manager`: データベース管理
- `global_config`: グローバル設定

### データフロー

```
証拠データベース (database.json)
    ↓
TimelineBuilder.build_timeline()
    ↓ 日付抽出・ソート
TimelineEvent のリスト
    ↓
generate_objective_narrative() または generate_narrative()
    ↓ AI生成 or 基本生成
客観的ストーリー（テキスト）
    ↓
export_timeline()
    ↓ 形式変換
JSON / Markdown / HTML / Text ファイル
```

### AI生成プロンプト

```python
"""
あなたは法律文書の専門家です。提供された証拠の時系列情報から、
完全に客観的で中立的なストーリーを生成してください。
法的判断や主観的評価は一切含めず、証拠から得られる事実のみを
時系列順に記述してください。
"""
```

**要件**:
1. 完全に客観的・中立的な記述
2. 証拠から得られる事実のみ
3. 時系列順に整理された流れ
4. 各事実の日付と証拠番号を明記
5. 因果関係は客観的に記述可能な範囲のみ
6. 読みやすい日本語の文章形式

---

## ファイル構成

```
/home/user/webapp/
├── timeline_builder.py              # メイン実装（拡張版）
├── run_phase1_multi.py              # メニュー統合（更新）
├── TIMELINE_STORY_GUIDE.md          # 使用ガイド（新規）
├── test_timeline_builder.py         # テストスクリプト（新規）
└── IMPLEMENTATION_SUMMARY_TIMELINE.md  # 本ドキュメント（新規）
```

---

## 使用例

### 基本的な使用

```bash
# Phase1システムを起動
cd /home/user/webapp
python3 run_phase1_multi.py

# メニューから選択
# 7. 時系列ストーリーの生成（証拠を時系列で整理）

# AI機能を選択
# 1. AI生成の客観的ストーリー（推奨）

# 出力形式を選択
# 4. HTML形式（ブラウザで閲覧可能）
```

### テストスクリプトの実行

```bash
cd /home/user/webapp
python3 test_timeline_builder.py

# テスト項目を選択
# 4. すべてのテストを実行
```

---

## 出力例

### JSON形式

```json
{
  "metadata": {
    "case_id": "meiyokison_case001",
    "case_name": "名誉毀損事件",
    "generated_at": "2025-10-22T10:30:00",
    "total_events": 25,
    "ai_generated": true
  },
  "timeline": [...],
  "ai_narrative": "# 事件の時系列ストーリー...",
  "relationships": {
    "temporal_clusters": [...],
    "chronological_gaps": [...]
  }
}
```

### HTML形式（抜粋）

```html
<!DOCTYPE html>
<html lang='ja'>
<head>
  <title>時系列ストーリー - 名誉毀損事件</title>
  <style>
    /* カラフルで読みやすいデザイン */
  </style>
</head>
<body>
  <div class='header'>
    <h1>事件の時系列ストーリー</h1>
  </div>
  <div class='section'>
    <h2>AI 生成の客観的ストーリー</h2>
    <div class='ai-narrative'>...</div>
  </div>
  ...
</body>
</html>
```

---

## 期待される効果

1. **証拠整理の自動化**
   - 手動での証拠ソート作業が不要に
   - 日付情報の自動抽出で正確性向上

2. **準備書面作成の効率化**
   - 時系列の流れを客観的に把握
   - 事実関係の整理が容易に

3. **証拠説明書の作成支援**
   - 作成年月日が正確に記録される
   - 立証趣旨の記載に活用可能

4. **訴訟戦略の検討**
   - 証拠間の関連性が明確に
   - 時系列のギャップを発見

---

## 今後の拡張予定

- [ ] **テーマ別クラスタリング**: 契約、支払い、通知などのテーマ別に証拠をグループ化
- [ ] **ビジュアルタイムライン**: Mermaid図やガントチャートの生成
- [ ] **複数事件の横断検索**: 類似の時系列パターンを検出
- [ ] **関連性スコア**: 証拠間の関連度を数値化
- [ ] **自動要約**: 期間ごとの出来事を自動要約
- [ ] **PDFエクスポート**: 印刷用の高品質PDF出力

---

## トラブルシューティング

### 問題1: 日付が抽出されない

**原因**: 証拠に日付情報が含まれていない

**解決方法**:
1. Phase1分析で `temporal_information.document_date` を確認
2. 「AI対話形式で分析内容を改善」で日付を追加
3. メタデータにEXIF情報があるか確認

### 問題2: AIストーリー生成が失敗する

**原因**: OpenAI APIキーが未設定、またはAPI呼び出しエラー

**解決方法**:
1. `.env` ファイルの `OPENAI_API_KEY` を確認
2. インターネット接続を確認
3. 基本的なストーリー（AI不使用）を選択

---

## まとめ

時系列ストーリー組み立て機能により、証拠データベースから**客観的な事実の流れ**を自動生成できるようになりました。

### 主要な成果

✅ **完全な客観性**: 法的判断を含まない中立的な記述  
✅ **AI活用**: GPT-4oによる読みやすいストーリー生成  
✅ **多様な出力**: JSON、Markdown、HTML、Text対応  
✅ **関連性分析**: 証拠間の時間的関係を自動検出  
✅ **使いやすさ**: インタラクティブなUI  

### 推奨ワークフロー

1. Phase1で全証拠を分析（日付情報を確実に抽出）
2. 時系列ストーリー生成（AI生成を推奨）
3. HTML形式でエクスポート（視覚的に確認）
4. 証拠説明書の作成時に参照
5. 準備書面で時系列を引用

---

**プルリクエスト**: https://github.com/ogaiku-wospe/create-junbisyomen/pull/2

**バージョン**: 1.0  
**実装者**: Claude Code Assistant  
**最終更新**: 2025年10月22日
