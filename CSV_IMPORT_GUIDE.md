# CSV/Excel Export/Import 機能 使用ガイド

## 概要

証拠一覧をCSVまたはExcelファイルにエクスポートし、編集後にdatabase.jsonへ反映する機能です。文書の作成日、ファイル名、文書種別などのメタデータを効率的に編集・更新できます。

## 📊 エクスポートモードの選択

### 1. **標準モード**
- **用途**: 主要フィールドの編集・確認
- **含まれる列**: 12列（証拠種別、ステータス、証拠番号、仮番号、作成日、分析状態、ファイル名、文書種別、作成者、宛先、要約、Google DriveファイルID）
- **メリット**: 
  - ✅ Excelで開いて直接編集しやすい
  - ✅ 列数が少なく見やすい
  - ✅ 一般的な編集作業に十分
- **推奨ソフト**: Excel, Google Sheets, Numbers

### 2. **拡張モード**（推奨）← **NEW!**
- **用途**: AI分析結果・OCR結果の編集
- **含まれる列**: 約45列（基本情報 + 自然言語フィールド）
  - メタデータ（ファイル名、サイズ、ページ数）
  - AI分析結果（証拠種別詳細、文書種別、作成日、時間的コンテキスト）
  - 関係者情報（組織3件、個人2件）
  - 視覚要素（レイアウト説明、テキスト内容要約）
  - 完全内容（完全な説明、詳細内容）
  - 法的重要性（客観的事実、文脈上の重要性、証明可能な事実5件）
  - 使用提案（推奨される使用方法）
  - OCRテキスト（OCR結果の全文）
  - 品質スコア（完全言語化レベル、信頼度スコア）
- **メリット**:
  - ✅ **自然言語フィールドを直接編集可能**
  - ✅ OCR結果の誤字脱字を修正できる
  - ✅ AI分析結果を手動で補正できる
  - ✅ JSON構造を意識せず編集可能
  - ✅ Excel/CSVで直接編集できる
- **推奨用途**:
  - **OCR結果の修正**（誤読の訂正）
  - **AI分析の補完**（欠落情報の追加）
  - **視覚情報の詳細化**（レイアウト説明の追記）
- **推奨ソフト**: Excel, Google Sheets

### 3. **完全モード**（上級者向け）
- **用途**: database.jsonの全データにアクセス
- **含まれる列**: 14列（標準モード + `complete_metadata_json`, `phase1_complete_analysis_json`）
- **メリット**:
  - ✅ database.jsonの全情報を保持
  - ✅ 高度なカスタマイズが可能
  - ✅ バックアップとして使用可能
- **注意点**:
  - ⚠️ JSON列が非常に長い（数千〜数万文字）
  - ⚠️ テキストエディタで開くと読みにくい
  - ⚠️ Excelで開くと列がずれる可能性
- **推奨ソフト**: Python, プログラム処理

## 📁 出力形式の選択

### CSV形式（`.csv`）
- **メリット**:
  - 軽量（ファイルサイズが小さい）
  - プログラムで処理しやすい
  - バージョン管理（Git）に適している
- **デメリット**:
  - Excelで開くと文字化けする可能性
  - JSON列が長いと見にくい
- **推奨用途**: 
  - プログラム処理
  - 標準モードでの簡易編集

### Excel形式（`.xlsx`）
- **メリット**:
  - Excelで直接開ける
  - 列幅、色分け、フィルタが設定済み
  - 文字化けしない
  - ステータスごとに背景色が変わる
- **デメリット**:
  - ファイルサイズが大きい
  - プログラム処理に openpyxl ライブラリが必要
- **推奨用途**:
  - **人間が編集する場合（最推奨）**
  - 標準モードでの編集

## 🎯 推奨される使い分け

| 用途 | モード | 形式 | 理由 |
|------|--------|------|------|
| **OCR結果の修正** | 拡張 | Excel | OCRテキストを直接編集可能 ← **NEW!** |
| **AI分析の補完** | 拡張 | Excel | AI分析結果を手動で補正 ← **NEW!** |
| **主要フィールド編集** | 標準 | Excel | 最も使いやすい、色分け・列幅設定済み |
| **簡易確認** | 標準 | CSV | 軽量、Excelで開ける |
| **プログラム処理** | 完全 | CSV | 全データにアクセス可能 |
| **バックアップ** | 完全 | CSV | 全情報を保持、バージョン管理可能 |
| **高度なカスタマイズ** | 完全 | CSV | PythonでJSON列を編集 |

## 使用方法

### 1. ファイルのエクスポート

```
メインメニュー → 6. 証拠一覧をエクスポート（CSV/Excel）
```

1. 証拠種別を選択（甲号証 or 乙号証）
2. **エクスポートモードを選択**:
   - `1`: 標準モード（主要フィールドのみ、編集しやすい）
   - `2`: 拡張モード（AI分析・OCR結果を個別列に展開、自然言語編集可能）← **推奨**
   - `3`: 完全モード（database.json全データをJSON列で出力）
   - `4`: キャンセル
3. **出力形式を選択**:
   - `1`: CSV形式（`.csv`）
   - `2`: Excel形式（`.xlsx`）← **人間が編集する場合は推奨**
4. ファイルが現在のディレクトリに作成されます
   - 標準モード例: `evidence_list_事件名_ko_20251022_143000.xlsx`
   - 拡張モード例: `evidence_list_事件名_ko_extended_20251022_143000.xlsx`
   - 完全モード例: `evidence_list_事件名_ko_full_20251022_143000.csv`

### 2. ファイルの編集

#### 標準モード（推奨）

エクスポートされたファイルをExcelや他のスプレッドシートソフトで開いて編集します。

**Excel形式（`.xlsx`）の場合**:
- ダブルクリックでExcelが開きます
- 列幅、ステータスの色分け、ヘッダー固定が設定済み
- そのまま編集できます

**CSV形式（`.csv`）の場合**:
- Excelで開く場合: 「データ」→「テキストファイルから」で開く
- エンコーディング: UTF-8
- 区切り文字: カンマ

#### 完全モード（上級者向け）

**⚠️ 注意**: 完全モードのファイルはPythonでの処理を推奨します。

**Pythonでの編集例**:
```python
import csv
import json

# CSVファイルを読み込み
with open('evidence_list_full.csv', 'r', encoding='utf-8-sig') as f:
    reader = csv.DictReader(f)
    data = list(reader)

# JSON列を編集
for row in data:
    # JSON文字列をPythonオブジェクトに変換
    metadata = json.loads(row['complete_metadata_json'])
    analysis = json.loads(row['phase1_complete_analysis_json'])
    
    # データ編集
    metadata['basic']['file_name'] = '新しいファイル名.pdf'
    analysis['ai_analysis']['document_type'] = '契約書'
    
    # JSON文字列に戻す
    row['complete_metadata_json'] = json.dumps(metadata, ensure_ascii=False)
    row['phase1_complete_analysis_json'] = json.dumps(analysis, ensure_ascii=False)

# CSVファイルに書き込み
with open('evidence_list_full_edited.csv', 'w', encoding='utf-8-sig', newline='') as f:
    writer = csv.DictWriter(f, fieldnames=reader.fieldnames)
    writer.writeheader()
    writer.writerows(data)
```

#### 編集可能なフィールド

**標準モード:**

| 列名 | 説明 | 例 |
|------|------|-----|
| **作成日** | 文書の作成日 | `2022-11-03` |
| **ファイル名** | 証拠ファイルの名前 | `契約書.pdf` |
| **文書種別** | 文書のタイプ | `契約書`, `メール`, `請求書` など |
| **作成者** | 文書の作成者・送信者 | `株式会社○○` |
| **宛先** | 文書の宛先・受信者 | `△△株式会社` |

**拡張モード（追加で編集可能なフィールド）:**

| カテゴリ | 列名 | 説明 |
|---------|------|------|
| **メタデータ** | ファイルサイズ、ページ数 | ファイル情報 |
| **証拠分析** | 証拠種別_詳細、フォーマット説明 | 証拠の詳細情報 |
| **文書情報** | 文書種別、作成日、時間的コンテキスト | 文書の時系列情報 |
| **関係者** | 組織1〜3（名称、役割、コンテキスト）<br>個人1〜2（名前、役割、コンテキスト） | 文書に登場する関係者 |
| **視覚要素** | レイアウト説明、テキスト内容要約、注目すべき特徴 | 文書の視覚的特徴 |
| **完全内容** | 完全な説明、詳細内容 | AI分析による詳細説明 |
| **法的情報** | 客観的事実、文脈上の重要性、証明可能な事実1〜5 | 法的観点の情報 |
| **使用提案** | 推奨される使用方法 | 証拠の活用方法 |
| **OCR結果** | **OCRテキスト** | **OCRで読み取った全文（編集可能）** |
| **品質** | 完全言語化レベル、信頼度スコア | 分析品質の指標 |

#### 編集できないフィールド（参照のみ）

- **証拠種別**: 甲号証/乙号証
- **ステータス**: 確定済み/整理済み_未確定/未分類
- **証拠番号**: 証拠ID（識別子として使用）
- **仮番号**: 一時的な証拠番号
- **分析状態**: 分析済み/未分析
- **要約**: AI分析結果のサマリー
- **Google DriveファイルID**: Google Drive上のファイル識別子

> ⚠️ **重要**: 「証拠番号」列は変更しないでください。この列は証拠を識別するために使用されます。

### 3. 編集したファイルのインポート

```
メインメニュー → 7. CSV編集内容をdatabase.jsonに反映
```

#### インポート手順

1. 編集したファイルのパスを入力
   - 絶対パス: `/Users/username/path/to/file.csv` または `/Users/username/path/to/file.xlsx`
   - 相対パス: `./evidence_list_ko_20251022.xlsx`
   - **CSV形式、Excel形式どちらでも対応**

2. **モード自動検出**
   - システムが自動的にモード（標準/拡張/完全）を検出
   - `complete_metadata_json` 列があれば完全モード
   - `OCRテキスト` 列があれば拡張モード
   - それ以外は標準モード

3. システムが変更箇所を検出し、プレビューを表示

4. 変更内容を確認
   
   **標準モードの例:**
   ```
   ✅ 標準モードCSV検出: 主要フィールドのみを更新します
   
   【更新プレビュー】 2件の証拠に変更があります
   
   1. 証拠番号: tmp_ko_001
      作成日: 2025-10-22 → 2022-11-03
      ファイル名: document.pdf → 契約書_修正版.pdf
   
   2. 証拠番号: tmp_ko_002
      文書種別: 不明 → メール
      作成者: → 株式会社ABC
   ```
   
   **拡張モードの例:**
   ```
   ✅ 拡張モードCSV検出: 自然言語フィールドを個別に更新します
   
   【更新プレビュー】 1件の証拠に変更があります
   
   1. 証拠番号: tmp_ko_001
      OCRテキスト: 賃貸借契釘書 → 賃貸借契約書
      完全な説明: （旧）本文書は... → （新）本文書は賃貸借契約書であり...
      組織1_名称: → 株式会社ABC不動産
      作成日: → 2022-11-03
      ... 他 8 件のフィールドが変更されました
   ```
   
   **完全モードの例:**
   ```
   ✅ 完全モードCSV検出: JSON列からdatabase.jsonの全データを読み取ります
   
   【更新プレビュー】 1件の証拠に変更があります
   
   1. 証拠番号: tmp_ko_001
      complete_metadata: 変更あり
      phase1_complete_analysis: 変更あり
   ```

5. 確認プロンプトで `yes` を入力

6. database.jsonが更新され、Google Driveに自動同期されます

#### インポート時の動作

| モード | 更新対象 | 動作 |
|--------|----------|------|
| **標準モード** | 主要12フィールドのみ | database.json内の該当フィールドのみを更新 |
| **拡張モード** | 自然言語フィールド約45項目 | database.json内のネストされた構造に個別に反映 |
| **完全モード** | 全データ | `complete_metadata`, `phase1_complete_analysis` を丸ごと置き換え |

## データ更新の仕組み

### 新データ構造での更新パス

- **ファイル名**: 
  - `evidence.original_filename`
  - `evidence.complete_metadata.basic.file_name`

- **作成日**: 
  - `evidence.phase1_complete_analysis.ai_analysis.objective_analysis.temporal_information.document_date`

- **文書種別**: 
  - `evidence.phase1_complete_analysis.ai_analysis.objective_analysis.document_type`

- **作成者/宛先**: 
  - `evidence.phase1_complete_analysis.ai_analysis.objective_analysis.parties_mentioned.organizations[]`

### 旧データ構造での更新パス（フォールバック）

- **作成日**: `evidence.temporal_information.document_date`
- **文書種別**: `evidence.phase1_complete_analysis.document_type`
- **作成者**: `evidence.phase1_complete_analysis.author`
- **宛先**: `evidence.phase1_complete_analysis.recipient`

システムは自動的に適切なデータ構造を検出して更新します。

## よくある質問

### Q1: CSVファイルの文字コードは何ですか？

A: UTF-8 with BOM（utf-8-sig）形式で出力されます。Excelで開く際に文字化けを防ぐためです。

### Q2: 証拠番号を変更するとどうなりますか？

A: 証拠番号は識別子として使用されるため、変更すると該当する証拠が見つからなくなります。スキップされます。

### Q3: 空白セルの扱いは？

A: 空白（または空文字列）のセルは変更として検出されません。現在の値が保持されます。

### Q4: 複数の証拠を一度に編集できますか？

A: はい、CSVファイル内の複数の証拠を編集し、一度にまとめて更新できます。

### Q5: 変更を元に戻すことはできますか？

A: database.jsonの変更履歴はGitで管理されている場合、Gitの履歴から復元できます。それ以外の場合は事前にバックアップを取ることをお勧めします。

### Q6: エクスポートとインポートで証拠種別が混在した場合は？

A: CSVには証拠番号が含まれているため、証拠種別が混在していても正しく識別されます。

## トラブルシューティング

### エラー: ファイルが見つかりません

- CSVファイルのパスが正しいか確認してください
- 相対パスの場合、カレントディレクトリを確認してください（`pwd`コマンド）

### 警告: 証拠番号がデータベースに見つかりません

- 証拠番号が変更されていないか確認してください
- データベースに該当する証拠が存在するか確認してください（メニュー5で確認）

### 変更箇所がありません

- CSV内のデータが現在のdatabase.jsonのデータと同じです
- 編集した列が正しいか確認してください（編集可能フィールドを参照）

### CSVファイルが壊れているように見える（完全モード）

**症状**: テキストエディタやExcelでCSV完全モードのファイルを開くと、列がずれて見える

**原因**: JSON列（`complete_metadata_json`, `phase1_complete_analysis_json`）が非常に長く（数千〜数万文字）、内部にカンマやクォートが含まれるため、視覚的に複雑に見える

**解決策**:
1. **Python標準の`csv`モジュールを使用する**（推奨）
   ```python
   import csv
   import json
   
   with open('evidence_list_full.csv', 'r', encoding='utf-8-sig') as f:
       reader = csv.DictReader(f)
       for row in reader:
           print(row['証拠番号'])  # 正しく読み込める
           metadata = json.loads(row['complete_metadata_json'])  # JSON解析成功
   ```

2. **Excelで開く場合は標準モードを使用する**
   - エクスポート時に「1. 標準モード」を選択
   - または「2. Excel形式 (.xlsx)」を選択

3. **完全モードCSVの確認方法**
   ```bash
   # Python で列数を確認
   python3 << 'EOF'
   import csv
   with open('evidence_list_full.csv', 'r', encoding='utf-8-sig') as f:
       reader = csv.DictReader(f)
       print(f"列数: {len(next(reader))}")  # 14列と表示されるはずoff
   EOF
   ```

**検証結果**: CSV完全モードファイルは正しく生成されており、Python標準ライブラリで問題なく読み込めます

### Excelで開くと文字化けする

- CSV形式ではなく、Excel形式（`.xlsx`）でエクスポートしてください
- CSV形式の場合: Excelの「データ」→「テキストファイルから」→ エンコーディング「UTF-8」で開く

### JSON列の編集方法がわからない（完全モード）

完全モードのJSON列は、Pythonでの編集を推奨します：

```python
import csv
import json

# CSVを読み込み
with open('evidence_list_full.csv', 'r', encoding='utf-8-sig') as f:
    reader = csv.DictReader(f)
    rows = list(reader)

# 特定の証拠のJSON列を編集
for row in rows:
    if row['証拠番号'] == 'tmp_ko_001':
        # JSON文字列をPythonオブジェクトに変換
        metadata = json.loads(row['complete_metadata_json'])
        
        # データ編集
        metadata['basic']['file_name'] = '新しいファイル名.pdf'
        
        # JSON文字列に戻す
        row['complete_metadata_json'] = json.dumps(metadata, ensure_ascii=False)

# CSVに書き出し
fieldnames = list(rows[0].keys())
with open('evidence_list_full_edited.csv', 'w', encoding='utf-8-sig', newline='') as f:
    writer = csv.DictWriter(f, fieldnames=fieldnames)
    writer.writeheader()
    writer.writerows(rows)
```

## 使用例

### ケース1: 文書の作成日を修正

1. CSVエクスポート
2. Excelで開く
3. 「作成日」列を修正（例: `2025-10-22` → `2022-11-03`）
4. CSVを保存
5. CSVインポート
6. プレビュー確認後、`yes` で更新

### ケース2: ファイル名を分かりやすく変更

1. CSVエクスポート
2. 「ファイル名」列を編集（例: `IMG_1234.pdf` → `賃貸借契約書_2022年11月.pdf`）
3. CSVインポート
4. 確認後、更新

### ケース3: 複数の証拠の文書種別を一括設定

1. CSVエクスポート
2. 複数行の「文書種別」列を編集（例: 全て `メール` に設定）
3. CSVインポート
4. 一括更新

### ケース4: OCR結果の誤読を修正（拡張モード）← **NEW!**

**シナリオ**: OCRが「契釘書」と誤読した文字を「契約書」に修正したい

1. CSVエクスポート（**拡張モード**を選択）
2. Excelで開く
3. 「OCRテキスト」列を修正
   - 修正前: `本文書は賃貸借契釘書である...`
   - 修正後: `本文書は賃貸借契約書である...`
4. 保存
5. インポート
6. プレビュー確認後、`yes` で更新
7. 次回のAI分析時に正しいOCRテキストが使用される

### ケース5: AI分析結果を手動で補完（拡張モード）← **NEW!**

**シナリオ**: AIが検出できなかった関係者情報を追加したい

1. CSVエクスポート（**拡張モード**を選択）
2. Excelで開く
3. 以下の列を編集:
   - 「組織1_名称」: `株式会社ABC不動産`
   - 「組織1_役割」: `賃貸人`
   - 「組織1_コンテキスト」: `本契約の貸主として記載`
   - 「個人1_名前」: `山田太郎`
   - 「個人1_役割」: `代表取締役`
4. 保存
5. インポート
6. 確認後、更新

### ケース6: 視覚情報の詳細化（拡張モード）← **NEW!**

**シナリオ**: 文書のレイアウト説明をより詳細にしたい

1. CSVエクスポート（**拡張モード**を選択）
2. Excelで開く
3. 「レイアウト説明」列を編集:
   - 修正前: `2ページの文書`
   - 修正後: `2ページの縦書き文書。1ページ目に契約条件、2ページ目に特約事項が記載されている`
4. 「注目すべき特徴」列を編集:
   - 追加: `印鑑押印あり, 割印あり, 朱書きで「控」の記載あり`
5. 保存
6. インポート
7. 確認後、更新

## 注意事項

1. **証拠番号の変更禁止**: 証拠番号は識別子として使用されるため、変更しないでください
2. **バックアップ推奨**: 重要なデータの場合、事前にdatabase.jsonのバックアップを取ることをお勧めします
3. **Google Drive同期**: 更新は自動的にGoogle Driveに同期されます
4. **文字エンコーディング**: CSVファイルはUTF-8 with BOM形式を維持してください
5. **日付形式**: 作成日はYYYY-MM-DD形式（例: 2022-11-03）で入力してください

## まとめ

CSV/Excel編集機能により、証拠のメタデータを効率的に管理できます：

✅ **3つのモード**: 標準モード（簡易編集） / **拡張モード（AI・OCR編集）** / 完全モード（全データアクセス）
✅ **2つの形式**: CSV形式（プログラム処理向け） / Excel形式（人間編集向け）
✅ **エクスポート → 編集 → インポート** の3ステップ
✅ **変更プレビュー**で安全な更新
✅ **自動モード検出**: CSV/Excelから自動判定（標準/拡張/完全）
✅ **自動的にGoogle Driveへ同期**
✅ **新旧データ構造の両方に対応**
✅ **複数証拠の一括編集が可能**
✅ **OCR結果の修正が可能**（拡張モード）
✅ **AI分析結果の補完が可能**（拡張モード）

### 🎯 推奨設定まとめ

| 用途 | モード | 形式 |
|------|--------|------|
| **OCR結果の修正（最推奨）** | **拡張モード** | **Excel形式** |
| **AI分析の補完（最推奨）** | **拡張モード** | **Excel形式** |
| **日常的な編集** | 標準モード | Excel形式 |
| **バックアップ** | 完全モード | CSV形式 |
| **プログラム処理** | 完全モード | CSV形式 |

---

**バージョン**: 3.0  
**最終更新**: 2025-10-22  
**関連PR**: [#3](https://github.com/ogaiku-wospe/create-junbisyomen/pull/3)  
**関連コミット**: 
- [5c5305b](https://github.com/ogaiku-wospe/create-junbisyomen/pull/3/commits/5c5305b) - CSV完全モード実装
- [b60ca62](https://github.com/ogaiku-wospe/create-junbisyomen/pull/3/commits/b60ca62) - Excel完全モード修正
- **NEW!** 拡張モード実装（OCR・AI分析結果の直接編集機能）
