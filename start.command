#!/bin/bash
# æº–å‚™æ›¸é¢ä½œæˆæ”¯æ´ã‚·ã‚¹ãƒ†ãƒ  - èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆmacOSç”¨ï¼‰
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§èµ·å‹•ã§ãã¾ã™

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(dirname "$0")"

# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
echo -ne "\033]0;æº–å‚™æ›¸é¢ä½œæˆæ”¯æ´ã‚·ã‚¹ãƒ†ãƒ \007"

# ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º
clear
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                            â•‘"
echo "â•‘          ğŸ“ æº–å‚™æ›¸é¢ä½œæˆæ”¯æ´ã‚·ã‚¹ãƒ†ãƒ  v3.7.2               â•‘"
echo "â•‘                                                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Python 3ã®ç¢ºèª
if ! command -v python3 &> /dev/null; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: Python 3ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo ""
    echo "ğŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•:"
    echo "   1. Homebrewã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: https://brew.sh/"
    echo "   2. Python 3ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: brew install python@3"
    echo ""
    read -p "Enterã‚­ãƒ¼ã‚’æŠ¼ã—ã¦çµ‚äº†..."
    exit 1
fi

# .envãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
if [ ! -f ".env" ]; then
    echo "âš ï¸  è­¦å‘Š: .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo ""
    echo "ğŸ“‹ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™:"
    echo "   1. .env.exampleã‚’.envã«ã‚³ãƒ”ãƒ¼"
    echo "   2. .envãƒ•ã‚¡ã‚¤ãƒ«ã«APIã‚­ãƒ¼ã‚’è¨­å®š"
    echo ""
    echo "ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ [y/N]"
    read -p "> " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "ğŸ“¦ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."
        if [ -f "setup.sh" ]; then
            bash setup.sh
        else
            cp .env.example .env
            echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
            echo "âš ï¸  .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„"
            echo ""
            read -p "Enterã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ç¶šè¡Œ..."
        fi
    else
        echo "âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"
        read -p "Enterã‚­ãƒ¼ã‚’æŠ¼ã—ã¦çµ‚äº†..."
        exit 1
    fi
fi

# ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç¢ºèª
echo "ğŸ” ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç¢ºèªä¸­..."
if ! python3 -c "import openai" 2>/dev/null; then
    echo "âš ï¸  ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo ""
    echo "ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã‹ï¼Ÿ [y/N]"
    read -p "> " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        if ! pip3 install -r requirements.txt 2>/dev/null; then
            echo "ğŸ”§ --break-system-packages ãƒ•ãƒ©ã‚°ã§ãƒªãƒˆãƒ©ã‚¤..."
            pip3 install --break-system-packages -r requirements.txt
        fi
    else
        echo "âŒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"
        echo "æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:"
        echo "  pip3 install --break-system-packages -r requirements.txt"
        read -p "Enterã‚­ãƒ¼ã‚’æŠ¼ã—ã¦çµ‚äº†..."
        exit 1
    fi
fi

echo ""
echo "âœ… ã‚·ã‚¹ãƒ†ãƒ ãƒã‚§ãƒƒã‚¯å®Œäº†"
echo ""
echo "ğŸš€ èµ·å‹•ä¸­..."
echo ""

# ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’èµ·å‹•
python3 run_phase1_multi.py

# çµ‚äº†æ™‚ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹å‰ã«å¾…æ©Ÿ
EXIT_CODE=$?
echo ""
if [ $EXIT_CODE -eq 0 ]; then
    echo "âœ… æ­£å¸¸çµ‚äº†ã—ã¾ã—ãŸ"
else
    echo "âŒ ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: $EXIT_CODE)"
fi
echo ""
read -p "Enterã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹..."
